<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Project Sprint Archive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { background: #132752; color: #f0f6ff; font-family: 'Inter',sans-serif; }
    .container { max-width: 1080px; margin: 36px auto; background: #1e356a; padding: 36px; border-radius: 18px; box-shadow: 0 6px 28px #0b153777; }
    h1 { font-size: 2.0em; text-align: center; color: #4befff; }
    .project-list { margin-top: 28px; }
    .project-card {
      background: #24387c; margin-bottom: 20px; padding: 16px 20px; border-radius: 10px; box-shadow: 0 2px 11px #19357533;
      border: 1.5px solid #3b82f677;
    }
    .project-card h2 { margin: 0 0 9px 0; font-size: 1.17em; }
    .project-actions { margin: 9px 0 0 0; }
    .sprint-list { margin: 10px 0 0 0; }
    .sprint-card {
      background: #203076; margin-bottom: 9px; padding: 10px 13px; border-radius: 7px;
      border: 1.3px solid #2656aa99;
      display: flex; flex-direction: row; align-items: center; gap: 10px;
    }
    .sprint-title-box { flex: 1 1 70%; }
    .compare-btn, .restore-btn, .delete-btn, .export-btn {
      margin-left: 5px;
      background: linear-gradient(92deg, #2671f2, #2959de 90%);
      color: #fff; font-weight: 600; padding: 5px 12px; border-radius: 8px; border: none; cursor: pointer; font-size: 0.97em;
    }
    .compare-btn:hover, .restore-btn:hover, .export-btn:hover { background: linear-gradient(92deg, #2959de 0%, #60a5fa 100%);}
    .delete-btn { background: #b91c1c; color: #ffe5e5; }
    .delete-btn:hover { background: #991b1b; }
    .export-btn { background: linear-gradient(92deg,#22c55e,#16a34a);}
    .export-btn:hover { background: linear-gradient(92deg,#16a34a,#4ade80);}
    .project-sortbar { margin: 7px 0 10px 0; }
    .project-sortbar select, .project-sortbar input {
      padding: 6px 8px; font-size: 1em; border-radius: 6px; border: 1px solid #15307677; margin-right: 9px; margin-bottom: 2px;
    }
    .comparison-section {
      background: #1e2e50; margin: 30px 0 0 0; border-radius: 18px; padding: 18px 20px;
      display: flex; flex-wrap: wrap; gap: 24px; justify-content: center;
    }
    .sprint-compare-card {
      background: #22366c; border-radius: 10px; padding: 16px 16px; min-width: 310px; max-width: 430px; flex: 1 1 310px;
      box-shadow: 0 2px 12px #14357522; border: 1px solid #3874da44;
    }
    .sprint-compare-card h3 { margin: 0 0 10px 0; color: #4befff;}
    .sprint-compare-card pre { white-space: pre-wrap; font-size: 1.08em; }
    .unassigned-section { background: #70492c; border: 2px solid #fbbf24; color: #ffe7c6; }
    .unassigned-section h2 { color: #ffd9b3; }
    @media (max-width:700px) { .container { padding: 12px 2vw; } .comparison-section { flex-direction: column; } }
  </style>
  <script>
  getProjectId().then(projectId => {
    console.log("Current projectId:", projectId);
    if (!projectId) {
      alert("No project selected!");
      window.location.href = "dashboard.html";
    }
  });
</script>
</head>
<body>
  <div class="container">
    <h1>ðŸ“œ Project Sprint Archive & Comparison</h1>
    <div style="margin-bottom:24px;">
      <button onclick="backupAllArchive()" class="export-btn" style="font-size:1.05em;">â¬‡ Backup All Projects & Sprints (.json)</button>
      <input type="file" id="importFile" accept="application/json" style="display:none;" onchange="restoreAllArchive(this)">
      <button onclick="document.getElementById('importFile').click();" class="export-btn" style="font-size:1.05em;">â¬† Restore/Import Archive (.json)</button>
    </div>
    <div class="project-list" id="projectList"></div>
    <div id="comparison" class="comparison-section"></div>
  </div>
  <script>
    // Helper for safe display
    function escapeHTML(str) {
      if (!str) return '';
      return str.replace(/[<>&'"]/g, c => (
        { '<':'&lt;', '>':'&gt;', '&':'&amp;', "'":'&#39;', '"':'&quot;' }[c]
      ));
    }

    function loadProjects() {
      return JSON.parse(localStorage.getItem('sprintProjects') || '{}');
    }

    function saveProjects(projects) {
      localStorage.setItem('sprintProjects', JSON.stringify(projects));
    }

    let comparison = [];
    let sortOptions = {}; // projectId: sort type
    let searchTerms = {}; // projectId: search string

    function renderProjects() {
      const projects = loadProjects();
      const projectList = document.getElementById('projectList');
      projectList.innerHTML = '';

      // ----- Orphaned/Unassigned Sprints -----
      let orphaned = [];
      for (const pid in projects) {
        projects[pid].forEach((s,idx) => {
          if (!s.projectId || !s.projectName) {
            orphaned.push({ pid, idx, sprint: s });
          }
        });
      }
      if (projects['undefined']) {
        projects['undefined'].forEach((s,idx) => {
          orphaned.push({ pid: 'undefined', idx, sprint: s });
        });
      }
      if (orphaned.length) {
        projectList.innerHTML += `<div class="project-card unassigned-section">
          <h2>Unassigned Sprints</h2>
          <div class="sprint-list">
            ${orphaned.map((o,i)=>`
              <div class="sprint-card">
                <div class="sprint-title-box"><b>${escapeHTML(o.sprint.title || 'Untitled Sprint')}</b></div>
                <label>Assign to Project:
                  <select onchange="assignOrphanSprint('${o.pid}',${o.idx},this.value)">
                    <option value="">Select project</option>
                    ${Object.keys(projects).filter(p=>p!=='undefined').map(p=>`
                      <option value="${p}">${escapeHTML(projects[p][0]?.projectName||p)}</option>
                    `).join('')}
                  </select>
                </label>
              </div>
            `).join('')}
          </div>
        </div>`;
      }

      // ----- Projects with Sprints -----
      if (Object.keys(projects).length === 0) {
        projectList.innerHTML += '<p>No sprints saved yet.</p>';
        return;
      }
      for (const projectId in projects) {
        const sprints = [...projects[projectId]];
        const projectName = sprints[0]?.projectName || projectId;

        // Sort
        let sortType = sortOptions[projectId] || 'newest';
        if (sortType === 'newest') sprints.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
        if (sortType === 'oldest') sprints.sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
        if (sortType === 'wordcount') sprints.sort((a,b) => (b.wordTarget || 0) - (a.wordTarget || 0));

        // Search
        let search = (searchTerms[projectId] || '').toLowerCase();
        let displaySprints = search
          ? sprints.filter(s => (s.title || '').toLowerCase().includes(search))
          : sprints;

        projectList.innerHTML += `
          <div class="project-card" id="proj-${projectId}">
            <h2>ðŸ“‚ ${escapeHTML(projectName)} <span style="font-size:0.82em;font-weight:400;color:#9fe5f3;">(${projectId})</span></h2>
            <div class="project-actions">
              <button class="export-btn" onclick='exportProject("${projectId}","json")'>â¬‡ Export .json</button>
              <button class="export-btn" onclick='exportProject("${projectId}","txt")'>â¬‡ Export .txt</button>
              <button class="delete-btn" onclick='deleteProject("${projectId}")'>ðŸ—‘ Delete Project</button>
            </div>
            <div class="project-sortbar">
              <label>Sort: 
                <select onchange="setSort('${projectId}',this.value)">
                  <option value="newest" ${sortType=='newest'?'selected':''}>Newest</option>
                  <option value="oldest" ${sortType=='oldest'?'selected':''}>Oldest</option>
                  <option value="wordcount" ${sortType=='wordcount'?'selected':''}>Word Count</option>
                </select>
              </label>
              <label>
                Search Title:
                <input type="text" placeholder="Title..." value="${searchTerms[projectId]||''}" oninput="setSearch('${projectId}',this.value)">
              </label>
            </div>
            <div class="sprint-list" id="sprints-${projectId.replace(/[^a-zA-Z0-9]/g,'_')}">
              ${displaySprints.map((s,idx)=>`
                <div class="sprint-card">
                  <div class="sprint-title-box">
                    <b>${escapeHTML(s.title || 'Untitled Sprint')}</b> 
                    <small>(${s.createdAt ? s.createdAt.substring(0,10) : ''}, Goal: ${s.wordTarget || '-'} words, ${s.days || '-'} days)</small>
                  </div>
                  <button class="compare-btn" onclick='selectForComparison("${projectId.replace(/"/g,"&quot;")}",${idx})'>Compare</button>
                  <button class="restore-btn" onclick='restoreSprint("${projectId.replace(/"/g,"&quot;")}",${idx})'>Continue</button>
                  <button class="delete-btn" onclick='deleteSprint("${projectId.replace(/"/g,"&quot;")}",${idx})'>ðŸ—‘</button>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
    }

    function setSort(projectId, sortType) {
      sortOptions[projectId] = sortType;
      renderProjects();
    }
    function setSearch(projectId, val) {
      searchTerms[projectId] = val;
      renderProjects();
    }

    // Export all sprints in a project
    function exportProject(projectId, type) {
      const projects = loadProjects();
      const sprints = projects[projectId] || [];
      if (!sprints.length) return alert("Nothing to export.");
      if (type === 'json') {
        const blob = new Blob([JSON.stringify(sprints, null, 2)], { type: 'application/json' });
        downloadBlob(blob, `project_${projectId}_sprints.json`);
      } else if (type === 'txt') {
        let text = '';
        sprints.forEach((sprint, sprintIdx) => {
          text += `--- Sprint ${sprintIdx+1} ---\nTitle: ${sprint.title}\nGoal: ${sprint.wordTarget} words in ${sprint.days} days\nStart: ${sprint.createdAt}\nDescription: ${sprint.desc}\n\n`;
          sprint.logs.forEach((log, idx) => {
            text += `Session ${idx + 1} â€” ${log.date}\nWords: ${log.wordCount}, Time: ${log.timeSpent}, Rating: ${log.rating || "-"}\nNotes: ${log.notes || ""}\n${log.content}\n\n`;
          });
        });
        const blob = new Blob([text], { type: 'text/plain' });
        downloadBlob(blob, `project_${projectId}_sprints.txt`);
      }
    }
    function downloadBlob(blob, filename) {
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Backup/Restore all projects
    function backupAllArchive() {
      const allProjects = localStorage.getItem('sprintProjects') || '{}';
      const blob = new Blob([allProjects], { type: 'application/json' });
      downloadBlob(blob, 'all_sprint_projects_backup.json');
    }

    function restoreAllArchive(input) {
      if (!input.files || !input.files[0]) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          if (!imported || typeof imported !== 'object') throw "Invalid format!";
          if (!confirm("This will overwrite your current archive. Continue?")) return;
          localStorage.setItem('sprintProjects', JSON.stringify(imported));
          alert("Archive restored! Reloading...");
          location.reload();
        } catch (err) {
          alert("Import failed: " + err);
        }
      };
      reader.readAsText(input.files[0]);
    }

    // Delete entire project
    function deleteProject(projectId) {
      if (!confirm("Delete this entire project and all its sprints? This cannot be undone!")) return;
      let projects = loadProjects();
      delete projects[projectId];
      saveProjects(projects);
      renderProjects();
      alert("Project deleted.");
    }

    // Delete a single sprint from a project
    function deleteSprint(projectId, idx) {
      if (!confirm("Delete this sprint? This cannot be undone!")) return;
      let projects = loadProjects();
      if (projects[projectId]) {
        projects[projectId].splice(idx, 1);
        if (projects[projectId].length === 0) delete projects[projectId];
        saveProjects(projects);
        renderProjects();
        alert("Sprint deleted.");
      }
    }

    // Assign orphaned sprint to a project
    function assignOrphanSprint(orphanPid, sprintIdx, targetPid) {
      let projects = loadProjects();
      if (!projects[orphanPid] || !projects[targetPid]) return alert("Project not found!");
      const sprint = projects[orphanPid][sprintIdx];
      if (!sprint) return alert("Sprint not found!");

      // Assign projectId and projectName
      sprint.projectId = targetPid;
      sprint.projectName = projects[targetPid][0]?.projectName || targetPid;

      // Move sprint to new project and remove from orphan/original
      projects[targetPid].push(sprint);
      projects[orphanPid].splice(sprintIdx, 1);
      if (projects[orphanPid].length === 0) delete projects[orphanPid];
      saveProjects(projects);
      alert("Sprint assigned!");
      renderProjects();
    }
    window.assignOrphanSprint = assignOrphanSprint;

    // Restore a sprint as active (copy to currentSprint)
    function restoreSprint(projectId, idx) {
      let projects = loadProjects();
      const sprint = projects[projectId]?.[idx];
      if (!sprint) return alert("Sprint not found.");
      localStorage.setItem('currentSprint', JSON.stringify(sprint));
      localStorage.setItem('currentProject', JSON.stringify({id: projectId, name: sprint.projectName}));
      alert("Sprint loaded! Go back to the Sprint Tool to continue editing this sprint.");
    }

    // Comparison logic
    function selectForComparison(projectId, idx) {
      const projects = loadProjects();
      const sprints = projects[projectId];
      const sprint = sprints[idx];
      if (window.comparison?.length >= 2) window.comparison = [];
      window.comparison = window.comparison || [];
      window.comparison.push(sprint);
      renderComparison();
    }
    function renderComparison() {
      const cmp = document.getElementById('comparison');
      if (!window.comparison || window.comparison.length === 0) { cmp.innerHTML = ""; return; }
      cmp.innerHTML = window.comparison.map(s =>
        `<div class="sprint-compare-card">
          <h3>${escapeHTML(s.title || "Untitled Sprint")}</h3>
          <div><b>Project:</b> ${escapeHTML(s.projectName || "?")}</div>
          <div><b>Goal:</b> ${s.wordTarget || "?"} words in ${s.days || "?"} days</div>
          <div><b>Start:</b> ${s.createdAt ? s.createdAt.substring(0,10) : ""}</div>
          <div style="margin:7px 0"><b>Description:</b> ${escapeHTML(s.desc || "")}</div>
          <div><b>Total Entries:</b> ${s.logs?.length || 0}</div>
          <pre>${s.logs?.map((l,idx) =>
            `Session ${idx+1}: ${l.date.substring(0,10)} ${l.date.substring(11,19)}\nWords: ${l.wordCount}\nTime: ${l.timeSpent}\nRating: ${l.rating || "-"}\nNotes: ${l.notes || ""}\n${l.content}\n`).join('\n')}</pre>
        </div>`
      ).join('');
      if (window.comparison.length === 2) cmp.innerHTML += `<div style="flex-basis:100%;text-align:center;"><br/><button class="compare-btn" onclick="window.comparison=[];renderComparison()">Clear Comparison</button></div>`;
    }

    // Run on page load
    renderProjects();
    window.setSort = setSort;
    window.setSearch = setSearch;
    window.selectForComparison = selectForComparison;
    window.restoreSprint = restoreSprint;
    window.exportProject = exportProject;
    window.deleteSprint = deleteSprint;
    window.deleteProject = deleteProject;
    window.backupAllArchive = backupAllArchive;
    window.restoreAllArchive = restoreAllArchive;
  </script>
</body>
</html>
