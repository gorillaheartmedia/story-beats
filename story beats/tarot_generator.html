<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Tarot Deck Selector</title>
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
  <style>
    :root {
      --main-blue: #1958ca;
      --accent-blue: #3b82f6;
    }
    html, body { height: 100%; min-height: 100vh; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #143575 60%, #1958ca 100%);
      color: #e8ecfa;
      margin: 0;
      min-height: 100vh;
      padding: 0;
    }
    .container {
      max-width: 820px;
      margin: 36px auto 36px auto;
      background: rgba(24,39,70,0.95);
      border-radius: 18px;
      box-shadow: 0 4px 28px #06103a66;
      padding: 32px 28px 36px 28px;
      border: 1.5px solid #3b82f644;
      animation: fadein 0.6s;
    }
    @keyframes fadein { from { opacity: 0; transform: translateY(24px);} to {opacity:1;transform:none;} }
    h1 {
      font-size: 2em;
      margin: 0 0 8px 0;
      color: #fff;
      letter-spacing: 0.01em;
    }
    .subtitle {
      color: #b9d8fc;
      margin-bottom: 18px;
      font-size: 1.02em;
    }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .leftbar {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .mini-btn, .nav-btn, .deck-btn {
      background: linear-gradient(92deg, #2671f2, #2959de 90%);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: background .15s, color .14s, transform .06s;
      box-shadow: 0 2px 10px #12326d2a;
    }
    .mini-btn:active, .nav-btn:active, .deck-btn:active { transform: translateY(1px); }
    .nav-btn {
      padding: 8px 16px;
      font-size: 1.0em;
    }
    .mini-btn {
      padding: 6px 13px;
      font-size: 0.94em;
      background: linear-gradient(92deg, #1d346e 20%, #3282f0 80%);
      color: #aedcff;
    }
    .deck-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 18px;
      margin-top: 18px;
    }
    .deck-card {
      background: rgba(255,255,255,0.12);
      border: 1.5px solid #2953a950;
      border-radius: 14px;
      box-shadow: 0 2px 12px #0a194e29;
      padding: 20px 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 160px;
    }
    .deck-card h2 {
      font-size: 1.18em;
      color: #b7d8fd;
      margin: 0 0 6px 0;
      font-weight: 700;
      letter-spacing: .01em;
    }
    .deck-desc { color: #e8ecfa; font-size: 1.02em; }
    .deck-btn {
      margin-top: auto;
      padding: 10px 16px;
      font-size: 1.02em;
    }
    .project-pill {
      background: #18355c;
      color: #cdeaff;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.95em;
      border: 1px solid #2a5fb8aa;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .footer {
      margin-top: 22px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      color: #b9d8fc;
      font-size: 0.98em;
    }

    /* Optional floating research FAB, kept consistent with rest of app */
    .fab-research {
      position: fixed;
      right: 32px;
      bottom: 32px;
      z-index: 9999;
      width: 62px;
      height: 62px;
      background: linear-gradient(130deg, #4befff 60%, #1958ca 100%);
      border-radius: 50%;
      box-shadow: 0 2px 22px #2b7aff66;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background .14s, box-shadow .12s;
    }
    .fab-research:hover {
      background: linear-gradient(110deg, #1958ca 40%, #4befff 100%);
      box-shadow: 0 4px 34px #3be3ff99;
    }
    .fab-research .fab-icon {
      font-size: 2em;
      color: #14283c;
      filter: drop-shadow(0 2px 4px #fffbe933);
      user-select: none;
    }
    .fab-research:after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 78px;
      right: 0;
      background: #14283ccc;
      color: #fffbb0;
      padding: 6px 16px;
      border-radius: 9px;
      font-size: 1em;
      font-weight: 500;
      pointer-events: none;
      opacity: 0;
      transform: translateY(12px);
      transition: opacity .17s, transform .17s;
      white-space: nowrap;
    }
    .fab-research:hover:after {
      opacity: 1;
      transform: translateY(0);
    }
    @media (max-width:700px) {
      .container { padding: 14px 2vw 20px 2vw; }
    }
  </style>
  <script>
  getProjectId().then(projectId => {
    console.log("Current projectId:", projectId);
    if (!projectId) {
      alert("No project selected!");
      window.location.href = "dashboard.html";
    }
  });
</script>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="leftbar">
        <button class="nav-btn" id="backCoreBtn">‚Üê Back to Core Project</button>
        <span class="project-pill" id="projPill" title="Current Project">No project loaded</span>
      </div>
      <button class="mini-btn" id="backDashboardBtn">Dashboard</button>
    </div>

    <h1>Tarot Deck Selector</h1>
    <div class="subtitle">Choose which deck you want to use for this session.</div>

    <div class="deck-grid">
      <div class="deck-card">
        <h2>Classic Tarot Deck</h2>
        <div class="deck-desc">
          Full 78‚Äëcard Major/Minor Arcana workflow. Great for archetypes, spreads, and classic readings.
        </div>
        <button class="deck-btn" onclick="goToDeck('classic')">Use Classic Deck ‚Üí</button>
      </div>

      <div class="deck-card">
        <h2>Trope Deck</h2>
        <div class="deck-desc">
          Story tropes and genre archetypes as cards. Fast ideation for scenes, beats, and characters.
        </div>
        <button class="deck-btn" onclick="goToDeck('trope')">Use Trope Deck ‚Üí</button>
      </div>
    </div>

    <div class="footer">
      <div>Tip: your project ID will be carried along automatically.</div>
      <div id="idEcho"></div>
    </div>
  </div>

  <!-- Optional FAB (no-op by default; wire it up if you use a research page) -->
  <div class="fab-research" data-tooltip="Research" onclick="openResearch()" title="Research">
    <span class="fab-icon">üîé</span>
  </div>

  <script>
    // ---- Utilities ----
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }
    function getProjects() {
      try { return JSON.parse(localStorage.getItem("plotProjects") || "[]"); }
      catch(e){ return []; }
    }
    function safeText(s) {
      if (!s) return "";
      return String(s).replace(/[<>&"']/g, c => ({
        "<":"&lt;", ">":"&gt;", "&":"&amp;", "\"":"&quot;", "'":"&#39;"
      }[c]));
    }

    // ---- State init ----
    const params = new URLSearchParams(location.search);
    let projectId = params.get("id") || sessionStorage.getItem("currentPlotProjectId") || "";
    if (projectId) sessionStorage.setItem("currentPlotProjectId", projectId);

    // Try to show project title if we have it
    (function renderProjectPill(){
      const pill = document.getElementById("projPill");
      const echo = document.getElementById("idEcho");
      if (!projectId) {
        pill.textContent = "No project loaded";
        echo.textContent = "";
        return;
      }
      const projects = getProjects();
      const proj = projects.find(p => p.id === projectId);
      if (proj) {
        pill.textContent = proj.title ? ("Project: " + proj.title) : ("Project ID: " + projectId);
      } else {
        pill.textContent = "Project ID: " + projectId;
      }
      echo.innerHTML = "<b>ID:</b> " + safeText(projectId);
    })();

    // ---- Navigation handlers ----
    function goToDeck(type) {
      const page = (type === "classic") ? "tarot_classic.html" : "tarot_trope.html";
      let url = page;
      if (projectId) url += "?id=" + encodeURIComponent(projectId);
      location.href = url;
    }

    // Back to core project page (adjust file name if your core page differs)
    document.getElementById("backCoreBtn").addEventListener("click", () => {
      let url = "core_project.html"; // <-- change to your exact core project filename if different
      if (projectId) url += "?id=" + encodeURIComponent(projectId);
      location.href = url;
    });

    // Optional: jump to dashboard
    document.getElementById("backDashboardBtn").addEventListener("click", () => {
      let url = "dashboard.html";
      if (projectId) url += "?id=" + encodeURIComponent(projectId);
      location.href = url;
    });

    // Optional research hook
    function openResearch() {
      // If you have a research.html page, keep id flowing:
      let url = "research.html";
      if (projectId) url += "?id=" + encodeURIComponent(projectId);
      // Otherwise this can be a no-op or different route.
      window.open(url, "_blank");
    }
  </script>
</body>
</html>