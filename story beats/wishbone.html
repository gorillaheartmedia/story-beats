<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fishbone Diagram ‚Äî Save/Export/Import + Project ID</title>
  <meta name="viewport" content="width=1600">
  <style>
    body { background: #182848; color: #fff; font-family: Inter,sans-serif; margin: 0; }
    .toolbar {
      display: flex; align-items: center; gap: 18px;
      justify-content: flex-start;
      padding: 30px 42px 10px 42px;
      background: #22345d;
      border-bottom: 2.2px solid #142443;
      font-size: 1.09em;
    }
    .toolbar label {
      font-weight: 600; letter-spacing: 0.04em; color: #ffe17c; margin-right: 7px;
    }
    .toolbar input[type='text'] {
      font-size: 1.05em;
      border-radius: 8px;
      border: none;
      padding: 7px 13px;
      width: 130px;
      margin-right: 13px;
      background: #fffbb0;
      color: #113;
      font-weight: bold;
    }
    .toolbar button {
      background: linear-gradient(92deg, #4befff, #2671f2 85%);
      color: #13325a;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      padding: 9px 22px;
      font-size: 1.03em;
      margin-right: 8px;
      cursor: pointer;
      box-shadow: 0 2px 14px #10225244;
      transition: background .15s, color .13s;
    }
    .toolbar button:hover {
      background: #ffe17c; color: #143575;
    }
    #boneSVG { display: block; margin: 36px auto 0 auto; background: #233e6d; border-radius: 18px; box-shadow: 0 4px 32px #133;}
    .floating-ui {
      position: fixed; left: 50%; top: 50%;
      background: #12325a; padding: 34px 32px 22px 32px;
      border-radius: 15px; color: #fff; min-width: 320px; min-height: 120px;
      box-shadow: 0 8px 44px #122233bb; z-index: 99;
      transform: translate(-50%,-50%);
      font-size: 1em;
    }
    .floating-ui label { display:block; margin:11px 0 7px 0; font-weight: 600;}
    .floating-ui input, .floating-ui textarea {
      width: 99%; border-radius: 8px; border: none; background: #172d4b;
      color: #fff; padding: 9px; font-size: 1.08em; margin-bottom: 11px;
    }
    .floating-ui textarea { resize: vertical; min-height: 60px;}
    .floating-ui .btn-row { margin-top: 18px; text-align: right; }
    .floating-ui button {
      background: linear-gradient(92deg,#2671f2,#2959de 90%);
      color: #fff; border: none; border-radius: 8px; font-weight: 600;
      padding: 10px 22px; font-size: 1.05em; margin-left: 7px; cursor: pointer;
      transition: background .14s;
    }
    .floating-ui button:hover { background: #4befff; color: #153366; }
    .floating-ui .del-btn { background: #b22234; color: #fffbb0;}
    .floating-ui .del-btn:hover { background: #fd4466; color: #fff;}
    .floating-ui h3 { margin-top: 0;}
    .reset-btn { position:fixed; top:24px; right:52px; background:linear-gradient(92deg,#feeb9a,#4befff 100%); color:#143575; border:none; border-radius:10px; padding:13px 28px; font-weight:700; font-size:1.12em; box-shadow:0 3px 19px #183 30; cursor:pointer; transition: background .14s; z-index: 4;}
    .reset-btn:hover { background: #2671f2; color: #fff; }
    .keyflow-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 32px;
      margin: 60px auto 0 auto;
      width: 100%;
    }
    .keyflow-box {
      background: #18357b;
      color: #eaf3ff;
      border: 2.3px solid #4befff;
      border-radius: 14px;
      font-size: 1.18em;
      min-width: 190px;
      padding: 23px 26px 20px 26px;
      font-weight: 600;
      cursor: pointer;
      position: relative;
      box-shadow: 0 2px 15px #12325a60;
      transition: border-color .14s, background .14s;
    }
    .keyflow-box:hover { background: #2959de; border-color: #ffe04b;}
    .keyflow-trash {
      position: absolute;
      top: 4px; right: 8px;
      font-size: 1.1em;
      color: #ff4d77;
      cursor: pointer;
      background: none; border: none;
    }
    .keyflow-add {
      background: #d9faff;
      color: #1298b6;
      border: 2.3px solid #4befff;
      border-radius: 14px;
      min-width: 160px;
      padding: 23px 26px 20px 26px;
      font-size: 1.18em;
      font-weight: 700;
      cursor: pointer;
      opacity: .92;
      transition: border-color .14s, background .14s;
    }
    .keyflow-add:hover { background: #4befff; color: #143575; border-color: #ffe04b;}
    ::selection { background: #4befff; color: #153366;}
  </style>
  <script>
  getProjectId().then(projectId => {
    console.log("Current projectId:", projectId);
    if (!projectId) {
      alert("No project selected!");
      window.location.href = "dashboard.html";
    }
  });
</script>
</head>
<body>
<div class="toolbar">
  <label for="projid">Project ID:</label>
  <input id="projid" type="text" value="fishbone-demo">
  <button onclick="saveProject()">üíæ Save</button>
  <button onclick="importProject()">üìÅ Import</button>
  <button onclick="exportProject()">‚¨á Export</button>
</div>
<button class="reset-btn" onclick="resetDiagram()">‚ü≤ Reset</button>
<svg id="boneSVG" width="1600" height="900"></svg>

<div class="keyflow-row" id="keyFlowRow"></div>
<input id="importFile" type="file" style="display:none" accept="application/json" onchange="loadImportFile(this)">

<!-- Modals (same as previous code above; no change) -->
<div id="causeModal" class="floating-ui" style="display:none;">
  <h3 id="causeModalTitle"></h3>
  <label>Label (shown on bone)
    <input id="causeLabelInput" maxlength="40" required>
  </label>
  <label>Description / Notes
    <textarea id="causeNotesInput" maxlength="300"></textarea>
  </label>
  <div class="btn-row">
    <button onclick="saveCause()">Save</button>
    <button onclick="closeCauseModal()">Cancel</button>
    <button class="del-btn" id="delCauseBtn" onclick="deleteCause()" style="display:none;">Delete</button>
  </div>
</div>
<div id="catModal" class="floating-ui" style="display:none;">
  <h3>Edit Category</h3>
  <label>Category Label
    <input id="catLabelInput" maxlength="24" required>
  </label>
  <div class="btn-row">
    <button onclick="saveCatEdit()">Save</button>
    <button onclick="closeCatModal()">Cancel</button>
  </div>
</div>
<div id="effectModal" class="floating-ui" style="display:none;">
  <h3>Edit Main Effect</h3>
  <label>Effect Label
    <input id="effectLabelInput" maxlength="60" required>
  </label>
  <label>Description / Notes
    <textarea id="effectNotesInput" maxlength="300"></textarea>
  </label>
  <div class="btn-row">
    <button onclick="saveEffectEdit()">Save</button>
    <button onclick="closeEffectModal()">Cancel</button>
  </div>
</div>
<div id="flowModal" class="floating-ui" style="display:none;">
  <h3>Edit Key Flow Step</h3>
  <label>Step Label
    <input id="flowLabelInput" maxlength="44">
  </label>
  <label>Notes / Description
    <textarea id="flowNotesInput" maxlength="300"></textarea>
  </label>
  <div class="btn-row">
    <button onclick="saveFlowEdit()">Save</button>
    <button onclick="closeFlowModal()">Cancel</button>
  </div>
</div>

<script>
const boneColors = [
  "#4befff", "#90f27c", "#ffb84b", "#ffa2a2", "#a2a9ff", "#ffe04b"
];
const defaultCategories = [
  { name: "PEOPLE", causes: [] },
  { name: "PROCESSES", causes: [] },
  { name: "EQUIPMENT", causes: [] },
  { name: "ENVIRONMENT", causes: [] },
  { name: "MATERIALS", causes: [] },
  { name: "MANAGEMENT", causes: [] }
];
const defaultEffect = { label: "MAIN EFFECT", notes: "" };
const defaultFlow = [
  { label: "Key Step 1", notes: "" },
  { label: "Key Step 2", notes: "" },
  { label: "Key Step 3", notes: "" },
  { label: "Key Step 4", notes: "" }
];

let categories = JSON.parse(JSON.stringify(defaultCategories));
let effectBox = JSON.parse(JSON.stringify(defaultEffect));
let flowSteps = JSON.parse(JSON.stringify(defaultFlow));

let editing = { catIdx: null, causeIdx: null, isNew: false };
let editingFlowIdx = null;
let editingCatIdx = null;

function resetDiagram() {
  categories = JSON.parse(JSON.stringify(defaultCategories));
  effectBox = JSON.parse(JSON.stringify(defaultEffect));
  flowSteps = JSON.parse(JSON.stringify(defaultFlow));
  closeCauseModal(); closeCatModal(); closeEffectModal(); closeFlowModal();
  drawBone(); drawKeyFlow();
}

function saveProject() {
  let id = document.getElementById("projid").value.trim();
  if (!id) { alert("Please enter a Project ID!"); return; }
  let data = { categories, effectBox, flowSteps };
  localStorage.setItem("fishbone-"+id, JSON.stringify(data));
  alert("Saved project '"+id+"' to localStorage.");
}

function importProject() {
  document.getElementById("importFile").value = "";
  document.getElementById("importFile").click();
}
function loadImportFile(input) {
  if (input.files && input.files[0]) {
    let reader = new FileReader();
    reader.onload = function(e) {
      try {
        let data = JSON.parse(e.target.result);
        categories = data.categories || JSON.parse(JSON.stringify(defaultCategories));
        effectBox = data.effectBox || JSON.parse(JSON.stringify(defaultEffect));
        flowSteps = data.flowSteps || JSON.parse(JSON.stringify(defaultFlow));
        drawBone(); drawKeyFlow();
        alert("Diagram imported!");
      } catch {
        alert("Import failed: Invalid JSON");
      }
    };
    reader.readAsText(input.files[0]);
  }
}
function exportProject() {
  let id = document.getElementById("projid").value.trim() || "fishbone-diagram";
  let data = JSON.stringify({ categories, effectBox, flowSteps }, null, 2);
  let blob = new Blob([data], {type:"application/json"});
  let a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = id + ".json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function drawBone() {
  const svg = document.getElementById("boneSVG");
  svg.innerHTML = "";
  const W = 1600, H = 900;
  const leftPad = 220, rightPad = 210;
  const spineY = 350;
  const boneLen = 240;
  const spineLen = W - leftPad - rightPad;

  // Draw spine
  svg.appendChild(makeSVG("line", {
    x1: leftPad, y1: spineY, x2: leftPad + spineLen, y2: spineY,
    stroke: "#26eaff", "stroke-width": 16, "stroke-linecap": "round"
  }));

  // Main Effect Box (slightly smaller!)
  let effectBoxW = 170, effectBoxH = 64;
  let effectRect = makeSVG("rect", {
    x: W-rightPad+34, y: spineY - effectBoxH/2, width: effectBoxW, height: effectBoxH, rx: 20,
    fill: "#a7e9ff", stroke: "#2671f2", "stroke-width": 3, style: "cursor:pointer;"
  });
  effectRect.onclick = openEffectEdit;
  svg.appendChild(effectRect);
  let effectLabel = makeSVG("text", {
    x: W-rightPad+34+effectBoxW/2, y: spineY+8, "font-size": "1.19em", "font-family": "Inter,sans-serif",
    "text-anchor": "middle", fill: "#193362", "font-weight": "bold", style: "cursor:pointer;"
  }, effectBox.label);
  effectLabel.onclick = openEffectEdit;
  svg.appendChild(effectLabel);

  // TOP/BOTTOM bones‚Äîstart at the spineY
  const N = 3;
  const topPoints = [
    leftPad, 
    leftPad + (spineLen/3),
    leftPad + (spineLen*2/3)
  ];
  const bottomPoints = [
    leftPad + (spineLen/6),
    leftPad + (spineLen/2),
    leftPad + (spineLen*5/6)
  ];
  const boxW = 180, boxH = 56, causeOffset = 102;

  // TOP BONES
  for(let i=0;i<N;++i) {
    const catIdx = i, boneX = topPoints[i], boneY = spineY, boneEndY = boneY - boneLen;
    svg.appendChild(makeSVG("line",{ x1: boneX, y1: boneY, x2: boneX, y2: boneEndY, stroke: boneColors[catIdx], "stroke-width": 10, "stroke-linecap": "round" }));
    // CATEGORY LABEL, now editable!
    let catRect = makeSVG("rect",{ x: boneX-boxW/2, y: boneEndY-44, width: boxW, height: 35, rx: 9, fill: boneColors[catIdx], stroke: "#eafffa", "stroke-width": 2, style: "cursor:pointer;" });
    catRect.onclick = ()=>openCatEdit(catIdx);
    svg.appendChild(catRect);
    let labelText = makeSVG("text",{ x: boneX, y: boneEndY-18, "font-size": "1.11em", "font-family": "Inter,sans-serif", "text-anchor": "middle", fill: "#143575", "font-weight": "bold", style:"cursor:pointer;" }, categories[catIdx].name);
    labelText.onclick = ()=>openCatEdit(catIdx);
    svg.appendChild(labelText);

    let nCauses = categories[catIdx].causes.length;
    for(let c=0;c<nCauses;++c) {
      let padFrac = 0.16;
      let frac = padFrac + (c+1)*(1-2*padFrac)/(nCauses+1);
      let cy = boneY - boneLen*frac, cx = boneX + ((c%2===0)?-1:1)*causeOffset;
      let conn = makeSVG("line",{ x1: boneX, y1: cy, x2: cx, y2: cy, stroke: boneColors[catIdx], "stroke-width": 4.2, "stroke-linecap": "round"});
      svg.appendChild(conn);
      let r = makeSVG("rect", { x: cx-boxW/2, y: cy-boxH/2, width: boxW, height: boxH, rx: 13, fill: "#fff", stroke: boneColors[catIdx], "stroke-width": 2, style: "cursor:pointer;" });
      r.onclick = ()=>openCauseModal(catIdx, c);
      svg.appendChild(r);
      let t = makeSVG("text", { x: cx, y: cy+9, "font-size": "1.09em", "font-family": "Inter,sans-serif", "text-anchor": "middle", fill: "#1958ca", style: "cursor:pointer;" }, categories[catIdx].causes[c].label || "(Unlabeled)");
      t.onclick = ()=>openCauseModal(catIdx, c);
      svg.appendChild(t);
    }
    let plusFrac = 0.12 + (nCauses+1)*(1-0.24)/(nCauses+2);
    let cy = boneY - boneLen*plusFrac, cx = boneX + ((nCauses%2===0)?-1:1)*causeOffset;
    let plus = makeSVG("rect",{ x: cx-boxW/2, y: cy-boxH/2, width: boxW, height: boxH, rx: 13, fill: "#d9faff", stroke: boneColors[catIdx], "stroke-width": 2, style: "cursor:pointer;opacity:.93" });
    plus.onclick = ()=>openCauseModal(catIdx, null);
    svg.appendChild(plus);
    let plusTxt = makeSVG("text",{ x: cx, y: cy+9, "font-size": "1.12em", "font-family": "Inter,sans-serif", "text-anchor": "middle", fill: "#1298b6", style: "cursor:pointer;font-weight:600;" },"+ Add Cause");
    plusTxt.onclick = ()=>openCauseModal(catIdx, null);
    svg.appendChild(plusTxt);
  }
  // BOTTOM BONES
  for(let i=0;i<N;++i) {
    const catIdx = i+N, boneX = bottomPoints[i], boneY = spineY, boneEndY = boneY + boneLen;
    svg.appendChild(makeSVG("line",{ x1: boneX, y1: boneY, x2: boneX, y2: boneEndY, stroke: boneColors[catIdx], "stroke-width": 10, "stroke-linecap": "round" }));
    let catRect = makeSVG("rect",{ x: boneX-boxW/2, y: boneEndY, width: boxW, height: 35, rx: 9, fill: boneColors[catIdx], stroke: "#eafffa", "stroke-width": 2, style: "cursor:pointer;" });
    catRect.onclick = ()=>openCatEdit(catIdx);
    svg.appendChild(catRect);
    let labelText = makeSVG("text",{ x: boneX, y: boneEndY+24, "font-size": "1.11em", "font-family": "Inter,sans-serif", "text-anchor": "middle", fill: "#143575", "font-weight": "bold", style:"cursor:pointer;" }, categories[catIdx].name);
    labelText.onclick = ()=>openCatEdit(catIdx);
    svg.appendChild(labelText);

    let nCauses = categories[catIdx].causes.length;
    for(let c=0;c<nCauses;++c) {
      let padFrac = 0.16;
      let frac = padFrac + (c+1)*(1-2*padFrac)/(nCauses+1);
      let cy = boneY + boneLen*frac, cx = boneX + ((c%2===0)?-1:1)*causeOffset;
      let conn = makeSVG("line",{ x1: boneX, y1: cy, x2: cx, y2: cy, stroke: boneColors[catIdx], "stroke-width": 4.2, "stroke-linecap": "round"});
      svg.appendChild(conn);
      let r = makeSVG("rect", { x: cx-boxW/2, y: cy-boxH/2, width: boxW, height: boxH, rx: 13, fill: "#fff", stroke: boneColors[catIdx], "stroke-width": 2, style: "cursor:pointer;" });
      r.onclick = ()=>openCauseModal(catIdx, c);
      svg.appendChild(r);
      let t = makeSVG("text", { x: cx, y: cy+9, "font-size": "1.09em", "font-family": "Inter,sans-serif", "text-anchor": "middle", fill: "#1958ca", style: "cursor:pointer;" }, categories[catIdx].causes[c].label || "(Unlabeled)");
      t.onclick = ()=>openCauseModal(catIdx, c);
      svg.appendChild(t);
    }
    let plusFrac = 0.12 + (nCauses+1)*(1-0.24)/(nCauses+2);
    let cy = boneY + boneLen*plusFrac, cx = boneX + ((nCauses%2===0)?-1:1)*causeOffset;
    let plus = makeSVG("rect",{ x: cx-boxW/2, y: cy-boxH/2, width: boxW, height: boxH, rx: 13, fill: "#d9faff", stroke: boneColors[catIdx], "stroke-width": 2, style: "cursor:pointer;opacity:.93" });
    plus.onclick = ()=>openCauseModal(catIdx, null);
    svg.appendChild(plus);
    let plusTxt = makeSVG("text",{ x: cx, y: cy+9, "font-size": "1.12em", "font-family": "Inter,sans-serif", "text-anchor": "middle", fill: "#1298b6", style: "cursor:pointer;font-weight:600;" },"+ Add Cause");
    plusTxt.onclick = ()=>openCauseModal(catIdx, null);
    svg.appendChild(plusTxt);
  }
}

function drawKeyFlow() {
  const flowRow = document.getElementById('keyFlowRow');
  flowRow.innerHTML = "";
  flowSteps.forEach((step, idx) => {
    let div = document.createElement('div');
    div.className = "keyflow-box";
    div.innerHTML = `<span>${step.label}</span>`;
    div.onclick = () => openFlowEdit(idx);
    if(flowSteps.length > 1) {
      let trash = document.createElement('button');
      trash.className = "keyflow-trash";
      trash.innerHTML = "üóë";
      trash.onclick = (e) => { e.stopPropagation(); removeFlow(idx); };
      div.appendChild(trash);
    }
    flowRow.appendChild(div);
  });
  let addBtn = document.createElement('button');
  addBtn.className = "keyflow-add";
  addBtn.textContent = "+ Add Flow Step";
  addBtn.onclick = addFlow;
  flowRow.appendChild(addBtn);
}

// --- Modal logic
function openCauseModal(catIdx, causeIdx) {
  editing.catIdx = catIdx;
  editing.causeIdx = causeIdx;
  editing.isNew = (causeIdx === null);
  const modal = document.getElementById('causeModal');
  document.getElementById('causeModalTitle').textContent =
    editing.isNew ? "Add Cause" : "Cause Details";
  document.getElementById('delCauseBtn').style.display = editing.isNew ? "none" : "";
  if(editing.isNew) {
    document.getElementById('causeLabelInput').value = "";
    document.getElementById('causeNotesInput').value = "";
  } else {
    let cause = categories[catIdx].causes[causeIdx];
    document.getElementById('causeLabelInput').value = cause.label || "";
    document.getElementById('causeNotesInput').value = cause.notes || "";
  }
  modal.style.display = "";
}
function closeCauseModal() {
  document.getElementById('causeModal').style.display = "none";
}
function saveCause() {
  const label = document.getElementById('causeLabelInput').value.trim();
  const notes = document.getElementById('causeNotesInput').value;
  if(!label) { alert("Label is required!"); return; }
  if(editing.isNew) {
    categories[editing.catIdx].causes.push({label, notes});
  } else {
    let cause = categories[editing.catIdx].causes[editing.causeIdx];
    cause.label = label; cause.notes = notes;
  }
  closeCauseModal();
  drawBone();
}

function deleteCause() {
  if(!editing.isNew) {
    categories[editing.catIdx].causes.splice(editing.causeIdx,1);
  }
  closeCauseModal();
  drawBone();
}

function openCatEdit(catIdx) {
  editingCatIdx = catIdx;
  document.getElementById('catLabelInput').value = categories[catIdx].name || "";
  document.getElementById('catModal').style.display = "";
}
function closeCatModal() {
  editingCatIdx = null;
  document.getElementById('catModal').style.display = "none";
}
function saveCatEdit() {
  const label = document.getElementById('catLabelInput').value.trim();
  if(label && editingCatIdx!==null) {
    categories[editingCatIdx].name = label;
    drawBone();
  }
  closeCatModal();
}

// Effect Modal
function openEffectEdit() {
  document.getElementById("effectLabelInput").value = effectBox.label;
  document.getElementById("effectNotesInput").value = effectBox.notes || "";
  document.getElementById("effectModal").style.display = "";
}
function closeEffectModal() {
  document.getElementById("effectModal").style.display = "none";
}
function saveEffectEdit() {
  let label = document.getElementById("effectLabelInput").value.trim();
  let notes = document.getElementById("effectNotesInput").value;
  if(label) {
    effectBox.label = label;
    effectBox.notes = notes;
    drawBone();
  }
  closeEffectModal();
}

// Key Flow logic
function openFlowEdit(idx) {
  editingFlowIdx = idx;
  document.getElementById("flowLabelInput").value = flowSteps[idx].label;
  document.getElementById("flowNotesInput").value = flowSteps[idx].notes || "";
  document.getElementById("flowModal").style.display = "";
}
function closeFlowModal() {
  editingFlowIdx = null;
  document.getElementById("flowModal").style.display = "none";
}
function saveFlowEdit() {
  let label = document.getElementById("flowLabelInput").value.trim();
  let notes = document.getElementById("flowNotesInput").value;
  if(label && editingFlowIdx !== null) {
    flowSteps[editingFlowIdx].label = label;
    flowSteps[editingFlowIdx].notes = notes;
  }
  closeFlowModal(); drawKeyFlow();
}
function removeFlow(idx) {
  if(flowSteps.length > 1) {
    flowSteps.splice(idx,1);
    drawKeyFlow();
  }
}
function addFlow() {
  flowSteps.push({label:"New Flow Step", notes:""});
  drawKeyFlow();
}

function makeSVG(type, props, text) {
  let el = document.createElementNS("http://www.w3.org/2000/svg", type);
  for (let k in props) el.setAttribute(k, props[k]);
  if (text) el.textContent = text;
  return el;
}
window.onload = function() {
  // Try to load project by ID if it exists
  let id = document.getElementById("projid").value.trim();
  let data = localStorage.getItem("fishbone-"+id);
  if (data) {
    try {
      let json = JSON.parse(data);
      categories = json.categories || JSON.parse(JSON.stringify(defaultCategories));
      effectBox = json.effectBox || JSON.parse(JSON.stringify(defaultEffect));
      flowSteps = json.flowSteps || JSON.parse(JSON.stringify(defaultFlow));
    } catch {}
  }
  drawBone();
  drawKeyFlow();
};
</script>
</body>
</html>
