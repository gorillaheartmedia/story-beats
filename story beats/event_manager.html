<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Event Manager</title>
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #143575 60%, #1958ca 100%); color: #e8ecfa; margin: 0; min-height: 100vh;}
    .container { max-width: 560px; margin: 38px auto 24px auto; background: rgba(24,39,70,0.97); border-radius: 18px; box-shadow: 0 4px 28px #06103a77; padding: 36px 28px 32px 28px; border: 1.5px solid #3b82f644;}
    h1 { font-size: 2em; margin-bottom: 14px; color: #fff;}
    .dashboard-btn, .timeline-btn, .scene-btn { background: linear-gradient(92deg, #2671f2, #2959de 90%); color: #fff; border: none; border-radius: 8px; font-weight: 600; font-size: 1em; padding: 8px 20px; margin-bottom: 12px; cursor: pointer; transition: background .15s, color .14s; box-shadow: 0 2px 9px #10399a24; margin-right: 12px; margin-top: 0;}
    .dashboard-btn:hover, .timeline-btn:hover, .scene-btn:hover { background: linear-gradient(92deg, #2959de 0%, #60a5fa 100%); color: #e0f4ff;}
    form label { display:block; margin-top:15px; font-weight: 500;}
    input[type="text"], input[type="number"], textarea, select { width:100%; padding:8px 10px; border-radius:6px; border:1.2px solid #284687; background: #19306a44; color: #e8ecfa; font-size: 1.04em; margin-top:5px;}
    textarea { resize:vertical;}
    .tags, .multi-list { display: flex; flex-wrap: wrap; gap: 8px; margin: 6px 0 0 0;}
    .tag, .multi-opt { background:#19306a55; border-radius:5px; padding:3px 13px; font-size:1em; color:#aee5ff; border:1px solid #3b82f644; cursor:pointer;}
    .tag button { margin-left:7px; background:none; border:none; color:#fff; font-size:1em; cursor:pointer;}
    .tag button:hover { color: #a42034;}
    .multi-opt.selected { background:#60a5fa; color:#18357b;}
    .multi-opt.add { background:#284687; color:#aee5ff; border:1px dashed #4bbcff;}
    .slider-bar {display:flex; align-items:center; gap:10px; margin-top:8px;}
    .slider-label {font-size:1.06em; color:#aee5ff;}
    .form-actions {text-align:right; margin-top:14px;}
    .form-actions button { font-size:1.08em; margin-left:10px; }
    .event-nav-bar { display:flex; align-items:center; justify-content:space-between; margin-bottom:18px;}
    .event-nav-arrows button { background: linear-gradient(92deg, #1958ca 30%, #60a5fa 100%); color:#fff; border:none; border-radius:7px; padding:7px 13px; font-size:1.1em; margin-left:7px; font-weight:600; cursor:pointer;}
    .event-nav-arrows button:disabled { background: #182352; color:#7893c0;}
    .event-index-label { color:#b9d8fc; font-size:1.03em; margin-left: 9px;}
    .img-btns {display:flex; gap:7px; margin-top:6px;}
    .img-url-input {width: calc(100% - 40px);}
    #imgFileName { margin:5px 0 0 2px; color:#aee5ff; font-size:1em;}
    @media (max-width:700px) { .container { padding: 10px 2vw 16px 2vw; } }
  </style>
  <script>
  getProjectId().then(projectId => {
    console.log("Current projectId:", projectId);
    if (!projectId) {
      alert("No project selected!");
      window.location.href = "dashboard.html";
    }
  });
</script>
</head>
<body>
  <div class="container">
    <div>
      <button onclick="window.location.href='project_core.html'" class="dashboard-btn">‚Üê Return to Hub</button>
      <button onclick="gotoTimeline()" class="timeline-btn">üìà Event Timeline</button>
      <button onclick="gotoSceneFromEvent()" class="scene-btn">üé¨ Open Linked Scene</button>
    </div>
    <div class="event-nav-bar">
      <span>
        <button onclick="navEvent(-1)" id="prevBtn">‚Üê</button>
        <span class="event-index-label" id="eventIndexLabel"></span>
        <button onclick="navEvent(1)" id="nextBtn">‚Üí</button>
      </span>
      <button type="button" onclick="clearForm()">+ New Event</button>
    </div>
    <h1 id="projTitle">Event Manager</h1>
    <form id="eventForm" onsubmit="saveEvent();return false;">
      <label>Order / Sequence
        <input id="eventOrder" type="number" min="1" step="1" placeholder="1, 2, 3, ...">
      </label>
      <label>Title / Description
        <input id="eventTitle" type="text" maxlength="90" placeholder="Short summary of this event" required/>
      </label>
      <label>When (Act/Scene/Chapter/Date)
        <input id="eventWhen" type="text" maxlength="32" placeholder="e.g. Act II, Scene 4, Day 10" />
      </label>
      <label>Link to Scene/Beat
        <select id="eventScene">
          <option value="">None</option>
        </select>
      </label>
      <label>Significance / Weight
        <div class="slider-bar">
          <input type="range" id="eventWeight" min="1" max="10" value="5" oninput="updateSliderLabel()">
          <span id="sliderVal" class="slider-label"></span>
        </div>
      </label>
      <label>Type / Tag
        <div class="tags" id="eventTags"></div>
        <input id="eventTagInput" type="text" maxlength="18" placeholder="Add tag & press Enter"/>
      </label>
      <label>Location
        <select id="eventLoc"><option value="">None</option></select>
      </label>
      <label>Characters Present
        <div class="multi-list" id="eventChars"></div>
        <input id="eventCharInput" type="text" maxlength="30" placeholder="Add new character & press Enter"/>
      </label>
      <label>Image
        <div class="img-btns">
          <input id="eventImgFile" type="file" accept="image/*" style="display:none;">
          <button type="button" onclick="document.getElementById('eventImgFile').click()">Upload Image</button>
          <button type="button" onclick="addImgFromURL()">From URL</button>
          <button type="button" onclick="clearImgPreview()">Remove</button>
        </div>
        <input id="eventImgURLInput" type="text" class="img-url-input" placeholder="Paste image URL and press Enter" style="display:none;">
        <div id="imgFileName"></div>
      </label>
      <label>Notes/Outcome
        <textarea id="eventNotes" rows="2" maxlength="180" placeholder="Notes, outcome, consequences, etc."></textarea>
      </label>
      <div class="form-actions">
        <button type="submit" id="saveBtn">üíæ Save Event</button>
        <button type="button" onclick="deleteEvent()" id="delBtn" style="color:#f99;">Delete</button>
      </div>
    </form>
  </div>
  <script>
    // --- Project Data ---
    function getQueryParam(name) {
      let params = new URLSearchParams(window.location.search);
      return params.get(name);
    }
    function getProjects() {
      return JSON.parse(localStorage.getItem("plotProjects") || "[]");
    }
    function setProjects(arr) {
      localStorage.setItem("plotProjects", JSON.stringify(arr));
    }

    let projectId = getQueryParam("id"),
        project=null, events=[], scenes=[], beats=[], locations=[], characters=[];
    let eventIdx = 0, modalTags=[], modalChars=[], modalImg=null, modalImgName = "";

    function loadProject() {
      if (!projectId) {
        alert("No project ID.");
        window.location.href = "dashboard.html";
        return;
      }
      let arr = getProjects();
      project = arr.find(p => p.id === projectId);
      if (!project) {
        alert("Project not found.");
        window.location.href = "dashboard.html";
        return;
      }
      if (!project.events) project.events = [];
      if (!project.scenes) project.scenes = [];
      if (!project.beats) project.beats = [];
      if (!project.locations) project.locations = [];
      if (!project.characters) project.characters = [];

      events = project.events;
      scenes = project.scenes;
      beats = project.beats;
      locations = project.locations;
      characters = project.characters;

      document.getElementById('projTitle').textContent =
        "Event Manager: " + (project.meta.storyTitle || "Untitled");

      // Check for focusEvent param (coming back from Scene Manager)
      const focusEventId = getQueryParam("focusEvent");
      if (focusEventId) {
        const foundEventIdx = events.findIndex(
          ev => ev.id === focusEventId || events.indexOf(ev).toString() === focusEventId
        );
        if (foundEventIdx !== -1) {
          eventIdx = foundEventIdx;
        }
      } else {
        if (events.length === 0) eventIdx = -1;
        else if (eventIdx < 0 || eventIdx >= events.length) eventIdx = 0;
      }

      renderSceneOptions();
      renderLocOptions();
      renderCharList();
      loadEventToForm();
      updateSliderLabel();
    }

    function saveProject() {
      project.events = events;
      let arr = getProjects();
      let idx = arr.findIndex(p => p.id === projectId);
      if (idx !== -1) {
        project.lastModified = (new Date()).toISOString();
        arr[idx] = project;
        setProjects(arr);
      }
    }

    // ---- Form Logic ----
    function loadEventToForm() {
      let lbl = document.getElementById("eventIndexLabel"),
          prev = document.getElementById("prevBtn"),
          next = document.getElementById("nextBtn");
      if (eventIdx === -1 || events.length === 0) {
        lbl.textContent = "(New)";
        prev.disabled = true; next.disabled = true;
        document.getElementById("saveBtn").textContent = "‚ûï Add Event";
        document.getElementById("delBtn").disabled = true;
        clearFormFields();
        return;
      }
      lbl.textContent = (eventIdx+1) + " / " + events.length;
      prev.disabled = (eventIdx <= 0);
      next.disabled = (eventIdx >= events.length-1);
      let e = events[eventIdx];
      document.getElementById("saveBtn").textContent = "üíæ Update Event";
      document.getElementById("delBtn").disabled = false;
      document.getElementById("eventOrder").value = typeof e.order === "number" ? e.order : (parseInt(e.order)||"");
      document.getElementById("eventTitle").value = e.title || "";
      document.getElementById("eventWhen").value = e.when || "";
      document.getElementById("eventScene").value = e.scene || "";
      document.getElementById("eventWeight").value = e.weight || 5;
      updateSliderLabel();
      modalTags = e.tags ? [...e.tags] : [];
      renderModalTags();
      document.getElementById("eventLoc").value = e.location || "";
      modalChars = e.characters ? [...e.characters] : [];
      renderCharList();
      modalImg = e.img || null;
      if (modalImg && modalImg.startsWith('data:')) modalImgName = "[uploaded image]";
      else if (modalImg) {
        let segs = modalImg.split("/");
        modalImgName = segs[segs.length-1] || "[image URL]";
      } else modalImgName = "";
      updateImgFilename();
      document.getElementById("eventNotes").value = e.notes || "";
    }

    function saveEvent() {
      let order = parseInt(document.getElementById('eventOrder').value.trim()) || 0;
      let title = document.getElementById('eventTitle').value.trim();
      let when = document.getElementById('eventWhen').value.trim();
      let scene = document.getElementById('eventScene').value;
      let weight = parseInt(document.getElementById('eventWeight').value) || 5;
      let tags = modalTags.slice();
      let location = document.getElementById('eventLoc').value;
      let chars = modalChars.slice();
      let notes = document.getElementById("eventNotes").value.trim();
      let img = modalImg;
      if (!title) return alert("Event title is required.");
      let obj = { order, title, when, scene, weight, tags, location, characters: chars, img, notes };
      if (eventIdx === -1) { events.push(obj); eventIdx = events.length-1;}
      else { events[eventIdx] = obj; }
      saveProject();
      loadEventToForm();
    }

    function clearFormFields() {
      document.getElementById("eventOrder").value = "";
      document.getElementById("eventTitle").value = "";
      document.getElementById("eventWhen").value = "";
      document.getElementById("eventScene").value = "";
      document.getElementById("eventWeight").value = 5;
      updateSliderLabel();
      modalTags = []; renderModalTags();
      document.getElementById("eventLoc").value = "";
      modalChars = []; renderCharList();
      modalImg = null; modalImgName = ""; updateImgFilename();
      document.getElementById("eventNotes").value = "";
    }

    function clearForm() { eventIdx = -1; loadEventToForm(); }

    function navEvent(dir) {
      if (eventIdx === -1 || events.length === 0) return;
      eventIdx += dir;
      if (eventIdx < 0) eventIdx = 0;
      if (eventIdx >= events.length) eventIdx = events.length-1;
      loadEventToForm();
    }

    function deleteEvent() {
      if (eventIdx === -1 || events.length === 0) return;
      if (!confirm("Delete this event?")) return;
      events.splice(eventIdx,1);
      if (eventIdx > 0) eventIdx--;
      else if (events.length===0) eventIdx = -1;
      saveProject();
      loadEventToForm();
    }

    function gotoTimeline() {
      window.location.href = "event_timeline.html?id="+encodeURIComponent(projectId);
    }

    // Jump to Scene Manager
    function gotoSceneFromEvent() {
  if (eventIdx === -1 || !events[eventIdx]) {
    alert("No event selected.");
    return;
  }
  const e = events[eventIdx];

  // Always store event & project so Scene Manager can add new scenes for this event
  localStorage.setItem("currentEvent", e.id || eventIdx.toString());
  localStorage.setItem("currentProject", projectId);

  if (e.scene) {
    // If a scene is linked, open that scene
    const sceneIndex = parseInt(e.scene);
    if (!isNaN(sceneIndex) && scenes[sceneIndex]) {
      localStorage.setItem("currentScene", scenes[sceneIndex].id || sceneIndex.toString());
    }
  }

  // Navigate regardless of whether a scene is linked
  window.location.href = "scene_manager.html?id=" + encodeURIComponent(projectId);
}

    // Modal tags
    function renderModalTags() {
      const tagDiv = document.getElementById("eventTags");
      tagDiv.innerHTML = "";
      modalTags.forEach((tag, i) => {
        const span = document.createElement("span");
        span.className = "tag";
        span.innerHTML = tag + ' <button onclick="removeModalTag(' + i + ')">√ó</button>';
        tagDiv.appendChild(span);
      });
    }
    function removeModalTag(i) { modalTags.splice(i, 1); renderModalTags(); }
    document.getElementById("eventTagInput").addEventListener("keydown", function (e) {
      if (e.key === "Enter" && this.value.trim()) {
        if (!modalTags.includes(this.value.trim())) { modalTags.push(this.value.trim()); }
        this.value = "";
        renderModalTags();
        e.preventDefault();
      }
    });

    // Modal character multi-select
    function renderCharList() {
      const charDiv = document.getElementById("eventChars");
      charDiv.innerHTML = "";
      characters.forEach(char => {
        let span = document.createElement("span");
        span.className = "multi-opt" + (modalChars.includes(char)?" selected":"");
        span.textContent = char;
        span.onclick = ()=>{
          if (modalChars.includes(char)) modalChars = modalChars.filter(c=>c!==char);
          else modalChars.push(char);
          renderCharList();
        };
        charDiv.appendChild(span);
      });
      let add = document.createElement("span");
      add.className = "multi-opt add";
      add.textContent = "+";
      add.onclick = ()=>{ document.getElementById("eventCharInput").focus(); };
      charDiv.appendChild(add);
    }
    document.getElementById("eventCharInput").addEventListener("keydown", function(e){
      if (e.key === "Enter" && this.value.trim()) {
        if (!characters.includes(this.value.trim())) characters.push(this.value.trim());
        if (!modalChars.includes(this.value.trim())) modalChars.push(this.value.trim());
        this.value = "";
        renderCharList();
      }
    });

    // Scene/beat/location options
    function renderSceneOptions() {
      const sel = document.getElementById("eventScene");
      sel.innerHTML = '<option value="">None</option>';
      scenes.forEach((s, i) => {
        const title = s.title || `Scene ${i+1}`;
        sel.innerHTML += `<option value="${i}">${title}</option>`;
      });
      if (beats.length) {
        sel.innerHTML += `<option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>`;
        beats.forEach((b,i) => {
          const title = b.title || `Beat ${i+1}`;
          sel.innerHTML += `<option value="beat${i}">[Beat] ${title}</option>`;
        });
      }
    }
    function renderLocOptions() {
      const sel = document.getElementById("eventLoc");
      sel.innerHTML = '<option value="">None</option>';
      locations.forEach(l => {
        sel.innerHTML += `<option value="${l.name||''}">${l.name||''}</option>`;
      });
    }

    // Slider label
    function updateSliderLabel() {
      const slider = document.getElementById('eventWeight');
      const val = parseInt(slider.value);
      let txt = ["Trivial","Background","Minor","Somewhat","Moderate","Important","Major","Critical","Crucial","Pivotal"];
      document.getElementById('sliderVal').textContent = val + " ("+txt[val-1]+")";
    }

    // Image handling
    document.getElementById("eventImgFile").addEventListener("change", function(ev){
      const file = this.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e){
        modalImg = e.target.result;
        modalImgName = file.name;
        updateImgFilename();
      };
      reader.readAsDataURL(file);
      this.value = '';
    });
    function updateImgFilename() {
      const fnameDiv = document.getElementById("imgFileName");
      if (modalImg) {
        let shown = modalImgName ? modalImgName : "[uploaded image]";
        fnameDiv.textContent = shown;
      } else {
        fnameDiv.textContent = "";
      }
    }
    function addImgFromURL() {
      document.getElementById("eventImgURLInput").style.display = "";
      document.getElementById("eventImgURLInput").focus();
    }
    document.getElementById("eventImgURLInput").addEventListener("keydown", function(e){
      if (e.key === "Enter" && this.value.trim()) {
        modalImg = this.value.trim();
        let segs = modalImg.split("/");
        modalImgName = segs[segs.length-1] || "[image URL]";
        updateImgFilename();
        this.value = "";
        this.style.display = "none";
      }
    });
    function clearImgPreview() {
      modalImg = null; modalImgName = "";
      updateImgFilename();
      document.getElementById("eventImgURLInput").style.display = "none";
    }

    // -- INIT --
    loadProject();
  </script>
</body>
</html>
