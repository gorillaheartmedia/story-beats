<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Relationship Compass (Story Mechanics Edition)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    html, body {
      height: 100%; margin: 0; padding: 0;
      background: linear-gradient(135deg, #193362 60%, #2652a7 100%);
    }
    body {
      font-family: 'Inter', Arial, sans-serif;
      color: #eaf3ff;
      min-height: 100vh;
    }
    .center-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 96vh;
      width: 100vw;
      margin: 0;
      padding: 0;
    }
    
    #compassSVG {
      display: block;
      margin: 0 auto;
      background: rgba(26, 52, 99, 0.29);
      border-radius: 46px;
      box-shadow: 0 12px 54px #12326d2a, 0 2px 1.5px #1933621c;
      border: 1.9px solid #3860a5;
      backdrop-filter: blur(9px);
      max-width: 99vw;
    }
    .modal-bg {
      display:none; position:fixed; left:0; top:0;
      width:100vw; height:100vh; z-index:999;
      background:rgba(19,43,97,0.29); align-items:center; justify-content:center;
    }
    .modal {
      background: rgba(34, 54, 96, 0.97);
      color: #eaf3ff;
      padding: 27px 36px 17px 34px;
      border-radius: 20px;
      min-width:295px;
      box-shadow:0 6px 33px #1c378899, 0 1px 1.5px #1933621c;
      border:1.5px solid #25477c;
      position:relative;
      font-size: 1.09em;
    }
    .close-btn {
      position:absolute; right:13px; top:9px;
      background:none; border:none;
      font-size:1.18em; color:#89bbf9; cursor:pointer;
    }
    .modal label {
      display:block; font-weight:600; margin-top: 13px;
    }
    .modal input, .modal textarea, .modal select {
      font-size:1.07em; margin-bottom:9px;
      border-radius:8px; border:1.4px solid #375f95;
      padding: 6px 8px; color: #244074;
      background: rgba(246,249,255,0.92);
    }
    .modal textarea { resize:vertical; }
    .modal input:focus, .modal select:focus, .modal textarea:focus {
      border-color: #3b9bfd;
      outline: none;
      background: #e5f2ff;
      color: #1c2957;
    }
    .modal button {
      background: linear-gradient(91deg, #3656a3 60%, #65b4ff 95%);
      color: #fafdff;
      border: none;
      border-radius: 9px;
      font-weight: 600;
      font-size: 1.09em;
      padding: 7px 18px;
      margin-top: 8px;
      box-shadow: 0 2px 10px #205a9955;
      cursor: pointer;
    }
    .modal button:hover {
      background: linear-gradient(91deg, #4a7df6 10%, #63c5ff 90%);
      color:#eaf3ff;
    }
    .compass-label {
      font-family:'Inter', Arial, sans-serif;
      font-size: 1.5em;
      font-weight: 900;
      fill: #eaf3ff;
      text-shadow: 0 2px 13px #22375a77;
      letter-spacing:0.10em;
      text-anchor: middle;
      user-select:none;
      pointer-events: none;
      opacity: 0.97;
      cursor: help;
    }
    .svg-hover-group { cursor: pointer; }
    .node-img {
      transition: transform .15s cubic-bezier(.36,1.6,.34,1), filter .12s;
      transform-box: fill-box;
      transform-origin: 50% 50%;
    }
    .svg-hover-group:hover .node-img {
      transform: scale(1.10);
      filter: drop-shadow(0 2px 11px #4593e9cc);
    }
    .node-name {
      font-size:1.15em;
      font-family:'Inter', Arial, sans-serif;
      font-weight: 600;
      fill: #eaf3ff;
      text-anchor:middle;
      user-select:none;
      pointer-events: none;
      filter: drop-shadow(0 4px 13px #224a9149);
      cursor: pointer;
    }
    .node-role {
      font-size:1.01em;
      font-family:'Inter', Arial, sans-serif;
      fill:#a5d6fd;
      font-weight:400;
      text-anchor:middle;
      user-select:none;
      pointer-events: none;
    }
    .node-meta {
      font-size:.99em;
      font-family:'Inter',Arial,sans-serif;
      fill:#94e8ea;
      text-anchor:middle;
      font-weight:500;
      opacity:.94;
      user-select:none;
      pointer-events:none;
    }
    .center-label {
      font-size:2.18em;
      font-family:'Inter',Arial,sans-serif;
      font-weight:800;
      fill:#fff;
      text-anchor:middle;
    }
    .center-role  {
      font-size:1.16em;
      font-family:'Inter',Arial,sans-serif;
      font-weight:400;
      fill:#a5d6fd;
      text-anchor:middle;
    }
    #focusPicker {
      font-size:1.12em;
      margin-bottom: 14px;
      padding: 7px 14px;
      border-radius: 9px;
      border: 1.5px solid #2652a7;
      background: #1b2c57;
      color: #aee5ff;
      box-shadow: 0 2px 9px #19336218;
      margin-top: 22px;
    }
    #focusPicker:focus { outline: 2px solid #6bdef9; }
    .cat-tip {
      background:#16315a;
      color:#caf7fa;
      border-radius:8px;
      font-size:1.05em;
      max-width: 310px;
      padding: 10px 13px;
      border: 1.2px solid #3b82f655;
      box-shadow:0 3px 11px #18357b25;
      position:fixed; z-index:1999;
      pointer-events:none;
      display:none;
      white-space:pre-line;
    }
  </style>
</head>
<body>
<script>
  // --- Compass slot definitions ---
const COMPASS = [
  { type: "Mentor",   angle: 270, description: "Guides, advises, or inspires the focus character. Often a source of wisdom or training." },
  { type: "Best Support", angle: 315, description: "The most reliable ally, always has your back in any situation." },
  { type: "Ally",     angle: 0, description: "General supporter or friend, helps the focus character achieve their goals." },
  { type: "Rival",    angle: 45, description: "A competitive peer, pushes the character through rivalry, not always hostile." },
  { type: "Enemy",    angle: 90, description: "Actively opposes the character’s aims, may be overtly hostile." },
  { type: "Nemesis",  angle: 135, description: "The ultimate antagonist—personal, inescapable, and deeply opposed." },
  { type: "Crush",    angle: 180, description: "The focus character’s romantic interest or infatuation." },
  { type: "Wildcard", angle: 225, description: "Unpredictable—sometimes friend, sometimes foe, always a surprise." }
];

// --- Get projectId from URL ---
const params = new URLSearchParams(window.location.search);
const projectId = params.get("projectId");
if (!projectId) {
  alert("No projectId found in URL.");
  window.location.href = "dashboard.html";
}

// --- LocalStorage keys ---
const charKey = `characters_${projectId}`;
const relKey  = `relationships_${projectId}`;

// --- Load data ---
let characters = JSON.parse(localStorage.getItem(charKey) || "[]");
let relationships = JSON.parse(localStorage.getItem(relKey) || "{}");

// --- Focus character ---
let focusChar = characters[0]?.name || "";
const focusParam = params.get("focus");
if (focusParam && characters.some(c => c.name === focusParam)) {
  focusChar = focusParam;
}

window.onload = function() {
  const picker = document.getElementById("focusPicker");
  picker.innerHTML = "";
  characters.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.name;
    opt.textContent = c.name;
    picker.appendChild(opt);
  });
  if (focusChar) picker.value = focusChar;
  picker.onchange = function() {
    focusChar = picker.value;
    renderCompass();
  };
  renderCompass();
};

function getChar(name) {
  return characters.find(c => c.name === name);
}

function getRelForType(center, type) {
  let rels = relationships[center] || {};
  for (let name in rels) {
    if (rels[name].type === type) {
      return { name, ...rels[name] };
    }
  }
  return null;
}

// --- Main Render Function ---
function renderCompass() {
  const svg = document.getElementById("compassSVG");
  svg.innerHTML = "";
  let cx = 650, cy = 460, bigR = 300, imgSize = 94;

  let centerChar = getChar(focusChar);
  if (!centerChar) {
    svg.innerHTML = `<text x="${cx}" y="${cy}" fill="#fff">No character selected</text>`;
    return;
  }
  let imgUrl = centerChar.image || "https://via.placeholder.com/140x140?text=No+Image";
  let profileUrl = `character_profile.html?projectId=${encodeURIComponent(projectId)}&characterId=${encodeURIComponent(centerChar.id)}`;

  svg.innerHTML += `
    <defs>
      <clipPath id="centerCircle">
        <circle cx="${cx}" cy="${cy-20}" r="70"/>
      </clipPath>
    </defs>
    <a href="${profileUrl}">
      <image 
        href="${imgUrl}" 
        x="${cx-70}" y="${cy-90}" 
        width="140" height="140"
        style="border-radius:50%;cursor:pointer;"
        clip-path="url(#centerCircle)"
      />
    </a>
    <a href="${profileUrl}">
      <text x="${cx}" y="${cy+74}" class="center-label" style="cursor:pointer;">${centerChar.name}</text>
    </a>
    <text x="${cx}" y="${cy+104}" class="center-role">(${centerChar.role || ""})</text>
  `;

  COMPASS.forEach(dom => {
    let angle = dom.angle * Math.PI / 180;
    let x = cx + Math.cos(angle) * bigR;
    let y = cy + Math.sin(angle) * bigR;
    let labX = cx + Math.cos(angle) * (bigR + 148);
    let labY = cy + Math.sin(angle) * (bigR + 110);

    svg.innerHTML += `<text x="${labX}" y="${labY}" class="compass-label"
      onmouseover="showTip('${escapeHtml(dom.description)}', event)"
      onmouseout="hideTip()">${dom.type}</text>`;

    let rel = getRelForType(focusChar, dom.type);
    let char = rel && rel.name ? getChar(rel.name) : null;

    if (char) {
      let cImg = char.image || "https://placehold.co/94x94/406ec8/fff?text=IMG";
      let metaStr = `S:${rel.strength || 5} T:${rel.trust || 5} I:${rel.influence || 5}`;
      svg.innerHTML += `
        <g class="svg-hover-group clickable-node" data-rel-type="${dom.type}">
          <image href="${cImg}" x="${x-imgSize/2}" y="${y-imgSize/2-4}" width="${imgSize}" height="${imgSize}" class="node-img"
            style="border-radius:50%;clip-path:circle(50%);" />
          <text x="${x}" y="${y+imgSize/2+32}" class="node-name">${char.name}</text>
          <text x="${x}" y="${y+imgSize/2+54}" class="node-role">${char.role||""}</text>
          <text x="${x}" y="${y+imgSize/2+72}" class="node-meta">${metaStr}</text>
        </g>
      `;
    } else {
      svg.innerHTML += `
        <circle cx="${x}" cy="${y}" r="40" fill="#2a4177" stroke="#a3cafc" stroke-width="2.2" style="opacity:.23; cursor:pointer;" 
          class="clickable-node" data-rel-type="${dom.type}" />
        <text x="${x}" y="${y+7}" class="node-name" style="opacity:.37; cursor:pointer;" 
          class="clickable-node" data-rel-type="${dom.type}">Assign</text>
      `;
    }
  });

  // Attach click handlers AFTER SVG is in DOM
  svg.querySelectorAll(".clickable-node").forEach(el => {
    el.addEventListener("click", e => {
      let type = el.getAttribute("data-rel-type");
      if (type) editRel(type);
    });
  });
}
// Tooltip
function showTip(txt, event) {
  const el = document.getElementById('catTip');
  el.innerHTML = txt;
  el.style.display = "block";
  let x = (event?.clientX||0)+22, y = (event?.clientY||0)-8;
  if (window.innerWidth - x < 330) x = window.innerWidth-340;
  el.style.left = x + "px";
  el.style.top = y + "px";
}
function hideTip() {
  document.getElementById('catTip').style.display = "none";
}
function escapeHtml(txt) {
  return txt?.replace(/[<>"'&]/g, s => ({
    '<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','&':'&amp;'
  })[s]) || "";
}

// Modal editing
let editingType = null;
function editRel(type) {
  editingType = type;
  document.getElementById('modalTitle').textContent = "Edit: " + type;
  const sel = document.getElementById('charSelect');
  sel.innerHTML = `<option value="">None</option>`;
  characters.forEach(c => {
    if (c.name !== focusChar) {
      let opt = document.createElement('option');
      opt.value = c.name;
      opt.textContent = c.name + (c.role ? " (" + c.role + ")" : "");
      sel.appendChild(opt);
    }
  });

  let rels = relationships[focusChar] || {};
  let match = null;
  for (let n in rels) {
    if (rels[n].type === type) {
      match = { ...rels[n], name: n };
    }
  }

  sel.value = match && match.name ? match.name : "";
  document.getElementById('roleInput').value = match?.role || "";
  document.getElementById('noteInput').value = match?.note || "";
  document.getElementById('strengthInput').value = match?.strength || 5;
  document.getElementById('trustInput').value = match?.trust || 5;
  document.getElementById('influenceInput').value = match?.influence || 5;

  document.getElementById('compassTypeDescription').textContent =
    COMPASS.find(c => c.type === type)?.description || '';

  document.getElementById('modalBg').style.display = "flex";
}
window.editRel = editRel; // ensure global

function closeModal() {
  document.getElementById('modalBg').style.display = "none";
}

function saveModal() {
  const name = document.getElementById('charSelect').value;
  const role = document.getElementById('roleInput').value.trim();
  const note = document.getElementById('noteInput').value.trim();
  const strength = parseInt(document.getElementById('strengthInput').value) || 5;
  const trust = parseInt(document.getElementById('trustInput').value) || 5;
  const influence = parseInt(document.getElementById('influenceInput').value) || 5;

  let rels = relationships[focusChar] || {};
  for (let n in rels) {
    if (rels[n].type === editingType) {
      delete rels[n];
    }
  }
  if (name) {
    rels[name] = { type: editingType, role, note, strength, trust, influence };
  }
  relationships[focusChar] = rels;
  localStorage.setItem(relKey, JSON.stringify(relationships));

  closeModal();
  renderCompass();
}

// Back to Profile Button
document.getElementById("backToProfileBtn").onclick = function () {
  let charObj = characters.find(c => c.name === focusChar);
  if (charObj) {
    window.location.href = `character_profile.html?projectId=${encodeURIComponent(projectId)}&characterId=${encodeURIComponent(charObj.id)}`;
  } else {
    alert("Character not found.");
  }
};

</script>
<body>
  <div class="center-wrap">
    <!-- Dropdown to pick focus character -->
    <select id="focusPicker"></select>
    
    <!-- Tip that shows if grid already exists -->
    <div class="grid-exists-tip">Select a focus character to view or edit their relationship compass.</div>
  
    <button id="backToProfileBtn" class="main-btn" style="margin-bottom:18px;">
  ← Back to Profile
</button>

    <!-- SVG Compass -->
    <svg id="compassSVG" width="1300" height="960"></svg>
  </div>

  <!-- Relationship Editing Modal -->
  <div class="modal-bg" id="modalBg" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <button class="close-btn" onclick="closeModal()">×</button>
      <h3 id="modalTitle" style="font-weight:700;font-size:1.15em;margin-bottom:10px;"></h3>

      <label>Assign Character:
        <select id="charSelect"></select>
      </label>

      <label>Role:
        <input id="roleInput" type="text" />
      </label>

      <label>Notes:
        <textarea id="noteInput" rows="2"></textarea>
      </label>

      <label>Strength:
        <input id="strengthInput" type="number" min="1" max="10" value="5" />
      </label>

      <label>Trust:
        <input id="trustInput" type="number" min="1" max="10" value="5" />
      </label>

      <label>Influence:
        <input id="influenceInput" type="number" min="1" max="10" value="5" />
      </label>

      <div style="margin-top:8px;color:#aee5ff; font-size:0.97em" id="compassTypeDescription"></div>

      <button onclick="saveModal()">Save</button>
    </div>
  </div>

  <!-- Tooltip -->
  <div class="cat-tip" id="catTip"></div>
</body>
</html>
