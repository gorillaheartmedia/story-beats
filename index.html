<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Project Dashboard</title>
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #143575 60%, #1958ca 100%);
      color: #f5faff;
      margin: 0; min-height: 100vh;
      padding: 0;
    }
    .container {
      max-width: 900px;
      margin: 38px auto 24px auto;
      background: rgba(24,39,70,0.95);
      border-radius: 18px;
      box-shadow: 0 4px 28px #06103a77;
      padding: 32px 28px 32px 28px;
      border: 1.5px solid #3b82f633;
      animation: fadein 0.7s;
    }
    @keyframes fadein { from { opacity: 0; transform: translateY(36px);} to {opacity:1;transform:none;}}
    h1 { font-size: 2.2em; margin-bottom: 7px; color: #fff;}
    h2 { color: #aee5ff; font-weight: 500; margin-top: 22px; font-size: 1.16em;}
    .top-bar { display: flex; gap: 16px; margin-bottom: 26px;}
    .main-btn, .mini-btn {
      background: linear-gradient(92deg, #2671f2, #2959de 90%);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1.09em;
      padding: 9px 25px;
      margin-right: 8px;
      margin-bottom: 7px;
      cursor: pointer;
      transition: background .15s, color .14s;
      box-shadow: 0 2px 12px #19306a16;
      letter-spacing: 0.01em;
      outline: none;
    }
    .main-btn:hover, .mini-btn:hover {
      background: linear-gradient(92deg, #2959de 0%, #60a5fa 100%);
      color: #e0f4ff;
    }
    .mini-btn {
      font-size: 0.98em;
      padding: 5px 13px;
      margin-bottom: 0;
      margin-top: 2px;
      box-shadow: none;
    }
    .mini-btn.red { background: linear-gradient(92deg, #a42034, #eb486b 90%);}
    .mini-btn.red:hover { background: linear-gradient(92deg, #b22234 0%, #fc6f96 100%);}
    .mini-btn.export { background: linear-gradient(92deg, #1958ca 20%, #3282f0 80%);}
    .mini-btn.export:hover { background: linear-gradient(92deg, #2671f2, #1d346e 100%);}
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 10px;
      margin-top: 10px;
    }
    th, td {
      padding: 11px 14px;
      background: rgba(255,255,255,0.12);
      border-radius: 8px;
      text-align: left;
      font-size: 1.06em;
      color: #d7ebff;
      border: none;
    }
    th { color: #aee5ff; background: rgba(24,39,70,0.7);}
    td:last-child { text-align: right;}
    .empty-row td {
      text-align: center;
      color: #b4c5e8;
      background: rgba(255,255,255,0.09);
      font-size: 1.06em;
    }
    input[type="file"] { display: none; }
    .fadein { animation: fadein .45s;}
    .project-title-link {
      color: #fff;
      text-decoration: underline;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.12em;
    }
    .project-title-link:hover { color: #3b82f6; }
    @media (max-width:700px) {
      .container { padding: 8px 3vw 20px 3vw; }
      table, th, td { font-size: 1em;}
    }

    /* FAB for floating nav */
    .fab-core-hub {
      position: fixed;
      right: 32px;
      bottom: 32px;
      z-index: 9999;
      width: 74px;
      height: 74px;
      background: linear-gradient(130deg, #ffe285 60%, #1958ca 100%);
      border-radius: 50%;
      box-shadow: 0 2px 32px #ffd70088;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background .14s, box-shadow .12s;
    }
    .fab-core-hub:hover {
      background: linear-gradient(110deg, #1958ca 40%, #ffe285 100%);
      box-shadow: 0 4px 34px #ffd70088;
    }
    .fab-core-hub .fab-icon {
      font-size: 2.5em;
      color: #14283c;
      filter: drop-shadow(0 2px 4px #fffbe933);
      user-select: none;
    }
    .fab-core-hub:after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 78px;
      right: 0;
      background: #14283ccc;
      color: #fffbb0;
      padding: 6px 16px;
      border-radius: 9px;
      font-size: 1em;
      font-weight: 500;
      pointer-events: none;
      opacity: 0;
      transform: translateY(12px);
      transition: opacity .17s, transform .17s;
      white-space: nowrap;
    }
    .fab-core-hub:hover:after {
      opacity: 1;
      transform: translateY(0);
    }
    /* Project Picker Modal */
    .modal-bg {
      display: none;
      position: fixed;
      left: 0; top: 0;
      width: 100vw; height: 100vh;
      z-index: 99999;
      background: rgba(19,43,97,0.55);
      align-items: center;
      justify-content: center;
    }
    .modal {
      background: #19377a;
      padding: 36px 34px 24px 32px;
      border-radius: 20px;
      min-width: 340px;
      max-width: 96vw;
      box-shadow: 0 7px 33px #1c378899;
      color: #fff;
      font-size: 1.17em;
      animation: fadein .22s;
    }
    .modal input, .modal select {
      padding: 12px;
      font-size: 1.15em;
      border-radius: 8px;
      border: none;
      margin-bottom: 18px;
      width: 100%;
      max-width: 340px;
      box-sizing: border-box;
      background: #173161;
      color: #fff;
    }
    .modal button {
      font-size: 1.08em;
      padding: 12px 32px;
      border-radius: 8px;
      font-weight: 600;
      background: linear-gradient(92deg,#2671f2,#1958ca 100%);
      color: #fff;
      border: none;
      box-shadow: 0 2px 12px #1c378899;
      cursor: pointer;
      margin-top: 12px;
    }
    .modal .project-list {
      margin-top: 15px;
    }
    .modal .project-item {
      margin-bottom: 10px;
      cursor: pointer;
      background: #22386d;
      padding: 9px 13px;
      border-radius: 7px;
      transition: background .11s;
    }
    .modal .project-item:hover {
      background: #3b82f6;
      color: #fffbb0;
    }
  </style>
  <!-- <script src="project-safety.js"></script> -->
</head>
<body>
  <!-- Floating Core Hub Button (returns to core, if set) -->
  <div class="fab-core-hub" data-tooltip="Go to Project Core" onclick="goToProjectCore()">
    <span class="fab-icon">üè†</span>
  </div>

  <!-- Project Picker/Creator Modal -->
  <div class="modal-bg" id="projectModalBg">
    <div class="modal">
      <h2>Choose a Project</h2>
      <div class="project-list" id="modalProjectList"></div>
      <hr style="margin:18px 0;">
      <h3 style="margin-bottom:8px;">Or Create New Project</h3>
      <input id="modalProjName" maxlength="48" placeholder="Project name..." />
      <input id="modalProjType" maxlength="32" placeholder="Type (Novel, Essay, etc)..." />
      <button onclick="modalCreateProject()">+ Create Project</button>
    </div>
  </div>

  <div class="container">
    <h1>üìÇ Story & Project Dashboard</h1>
    <div class="top-bar">
      <button class="main-btn" onclick="newProjectPrompt()">+ New Project</button>
      <button class="main-btn" onclick="document.getElementById('fileInput').click()">üìÇ Import Project</button>
      <input type="file" id="fileInput" accept=".json"/>
    </div>
    <h2>Your Projects</h2>
    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Type</th>
          <th>Last Modified</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="projectRows"></tbody>
    </table>
  </div>
  <script>
    // ------- Storage Model --------
    function getProjects() {
      return JSON.parse(localStorage.getItem("plotProjects") || "[]");
    }
    function setProjects(arr) {
      localStorage.setItem("plotProjects", JSON.stringify(arr));
    }
    function nowISO() {
      return (new Date()).toISOString();
    }
    function formatDate(iso) {
      if (!iso) return "";
      let d = new Date(iso);
      return d.toLocaleDateString() + " " + d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    }
    function uuid() {
      return 'p_' + Math.random().toString(36).slice(2, 10) + Date.now();
    }

    // ------- Render Dashboard -----
    function renderProjects() {
      let arr = getProjects();
      let tb = document.getElementById("projectRows");
      tb.innerHTML = "";
      if (!arr.length) {
        tb.innerHTML = `<tr class="empty-row"><td colspan="4">No projects yet. Click "New Project" or "Import Project".</td></tr>`;
        return;
      }
      arr.forEach((p, i) => {
        let t = p.meta?.storyTitle || "(Untitled)";
        let type = p.meta?.type || "";
        let lm = formatDate(p.lastModified || "");
        tb.innerHTML += `<tr>
          <td><span class="project-title-link" onclick="openProject('${p.id}')">${t}</span></td>
          <td>${type}</td>
          <td>${lm}</td>
          <td>
            <button class="mini-btn" onclick="renameProjectPrompt('${p.id}')">Rename</button>
            <button class="mini-btn export" onclick="exportProject('${p.id}')">Export</button>
            <button class="mini-btn red" onclick="deleteProjectPrompt('${p.id}')">Delete</button>
          </td>
        </tr>`;
      });
    }

    // ------- Open, Create, Rename, Delete, Export -------
    function openProject(id) {
      sessionStorage.setItem("currentPlotProjectId", id);
      localStorage.setItem("currentProjectId", id);
      window.location.href = "project_core.html?id=" + encodeURIComponent(id);
    }
    function newProjectPrompt() {
      let name = prompt("Project title?");
      if (name === null) return;
      name = name.trim() || "Untitled";
      let type = prompt("Type (Novel, Essay, etc)?", "Novel");
      let proj = {
        id: uuid(),
        meta: { storyTitle: name, author: "", type: type || "Novel", genres: [], premise: "" },
        beats: [],
        lastModified: nowISO()
      };
      let arr = getProjects();
      arr.unshift(proj); // newest at top
      setProjects(arr);
      sessionStorage.setItem("currentPlotProjectId", proj.id);
      localStorage.setItem("currentProjectId", proj.id);
      window.location.href = "project_core.html?id=" + encodeURIComponent(proj.id);
    }
    function renameProjectPrompt(id) {
      let arr = getProjects();
      let idx = arr.findIndex(p => p.id === id);
      if (idx === -1) return;
      let cur = arr[idx];
      let name = prompt("Rename project:", cur.meta.storyTitle || "");
      if (name === null) return;
      arr[idx].meta.storyTitle = name.trim() || "Untitled";
      arr[idx].lastModified = nowISO();
      setProjects(arr);
      renderProjects();
    }
    function deleteProjectPrompt(id) {
      if (!confirm("Delete this project? This cannot be undone.")) return;
      let arr = getProjects();
      let idx = arr.findIndex(p => p.id === id);
      if (idx === -1) return;
      arr.splice(idx, 1);
      setProjects(arr);
      renderProjects();
    }
    function exportProject(id) {
      let arr = getProjects();
      let p = arr.find(x => x.id === id);
      if (!p) return;
      const data = JSON.stringify(p, null, 2);
      let name = (p.meta.storyTitle || "plot_project").replace(/[^\w\d]+/g,"_");
      const blob = new Blob([data], {type: "application/json"});
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = name + ".json";
      document.body.appendChild(link);
      link.click();
      setTimeout(() => {
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
      }, 100);
    }

    // ------- Import Project -------
    document.getElementById('fileInput').addEventListener('change', function(ev) {
      const file = this.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const loaded = JSON.parse(e.target.result);
          if (!loaded.meta || !loaded.beats || !loaded.id) throw "Invalid file";
          let arr = getProjects();
          // Avoid duplicate IDs
          let newId = loaded.id;
          while (arr.find(p => p.id === newId)) newId = uuid();
          loaded.id = newId;
          loaded.lastModified = nowISO();
          arr.unshift(loaded);
          setProjects(arr);
          renderProjects();
          alert("Project imported!");
        } catch (err) {
          alert("Failed to import. Not a valid Plot Engine project file.");
        }
      };
      reader.readAsText(file);
      this.value = '';
    });

    // ------ Floating Core Hub FAB ------
    function goToProjectCore() {
      // Use session or localStorage to get current project
      const pid = sessionStorage.getItem('currentPlotProjectId') || localStorage.getItem('currentProjectId');
      if (pid) {
        window.location.href = `project_core.html?id=${encodeURIComponent(pid)}`;
      } else {
        // Open picker modal if none is set
        openProjectModal();
      }
    }

    // ------ Modal for No Project Selected ------
    function openProjectModal() {
      const modal = document.getElementById('projectModalBg');
      const list = document.getElementById('modalProjectList');
      const projects = getProjects();
      list.innerHTML = '';
      if (projects.length) {
        projects.forEach(proj => {
          let title = proj.meta?.storyTitle || "(Untitled)";
          let type = proj.meta?.type || "";
          let lm = formatDate(proj.lastModified || "");
          let item = document.createElement('div');
          item.className = 'project-item';
          item.innerHTML = `<b>${title}</b> <span style="font-size:0.92em;color:#b8e8ff;">${type}</span><br><span style="font-size:0.92em;color:#9cd6ff;">${lm}</span>`;
          item.onclick = function() {
            sessionStorage.setItem("currentPlotProjectId", proj.id);
            localStorage.setItem("currentProjectId", proj.id);
            window.location.href = "project_core.html?id=" + encodeURIComponent(proj.id);
          };
          list.appendChild(item);
        });
      } else {
        list.innerHTML = `<div style="color:#ffe285;font-weight:600;">No projects yet. Create one below!</div>`;
      }
      modal.style.display = 'flex';
    }

    function modalCreateProject() {
      let name = document.getElementById('modalProjName').value.trim() || "Untitled";
      let type = document.getElementById('modalProjType').value.trim() || "Novel";
      let proj = {
        id: uuid(),
        meta: { storyTitle: name, author: "", type: type, genres: [], premise: "" },
        beats: [],
        lastModified: nowISO()
      };
      let arr = getProjects();
      arr.unshift(proj);
      setProjects(arr);
      sessionStorage.setItem("currentPlotProjectId", proj.id);
      localStorage.setItem("currentProjectId", proj.id);
      window.location.href = "project_core.html?id=" + encodeURIComponent(proj.id);
    }

    // Show modal if page loaded without project set
    (function checkForProjectOnLoad() {
      if (
        !sessionStorage.getItem("currentPlotProjectId") &&
        !localStorage.getItem("currentProjectId")
      ) {
        openProjectModal();
      }
    })();

    // ------- INIT -------
    renderProjects();
  </script>
</body>
</html>
