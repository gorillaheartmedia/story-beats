

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Life Graph</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body { background: linear-gradient(135deg, #14233c 60%, #1958ca 100%); color:#e8ecfa; font-family: Inter,sans-serif; margin:0; height:100vh; }
    .modal-bg { position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(15,24,40,0.86);display:flex;align-items:center;justify-content:center;z-index:99;}
    .wizard, .graphbox { background: #14233c; border-radius:18px; box-shadow:0 4px 42px #0e223dcc; max-width:1100px;width:100%;padding:42px 36px 36px 36px; }
    h2 { margin:0 0 16px 0; font-size:2em; color:#fff;}
    label { display:block;margin:20px 0 7px 0;font-weight:600;font-size:1.08em;}
    input,textarea {width:100%;padding:12px 10px;font-size:1.07em;border-radius:7px;background:#18366c;border:none;color:#fff;margin-bottom:14px;}
    button {margin-top:20px;font-size:1.08em;padding:11px 28px;border-radius:8px;background:linear-gradient(92deg,#3282f0,#2b71ea 80%);color:#fff;border:none;font-weight:600;cursor:pointer;}
    #lifeGraph {
      width: 98vw;
      max-width: 1100px;
      height: 44vw;
      max-height: 600px;
      min-height: 300px;
      display: none;
      margin-top: 26px;
      border-radius: 14px;
      background: #101e3f;
      box-shadow: 0 2px 22px #1958ca33;
    }
    .edit-pop { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#132a54; border-radius:13px; box-shadow:0 2px 24px #1958ca33; z-index:999; padding:36px 30px 28px 30px; min-width:280px; }
    .edit-pop label { margin:7px 0 4px 0; }
    .edit-pop input, .edit-pop textarea { margin-bottom: 13px;}
    .edit-pop button { margin-right: 10px; }
    .close-btn { float:right; font-size:1.7em; color:#89aaff; background:none; border:none; cursor:pointer;}
    .topbar {display:flex;justify-content:space-between;align-items:center;}
    @media (max-width:1100px) {
      .wizard, .graphbox { max-width: 98vw; padding: 2vw; }
    }
    @media (max-width:700px) {
      #lifeGraph { height: 54vw; min-height: 220px; }
      .wizard, .graphbox { padding: 0.5vw; }
    }
  </style>
  <script>
  getProjectId().then(projectId => {
    console.log("Current projectId:", projectId);
    if (!projectId) {
      alert("No project selected!");
      window.location.href = "dashboard.html";
    }
  });
</script>
</head>
<body>
<div class="modal-bg">
  <div class="wizard" id="wizardContainer">
    <div class="topbar">
      <h2 id="titleHead">ðŸ§  Life Graph Wizard</h2>
      <button class="close-btn" onclick="window.close()" title="Close">&times;</button>
    </div>
    <div id="mainStep"></div>
    <canvas id="lifeGraph"></canvas>
    <div style="text-align:right;">
      <button id="resetBtn" style="margin-top:14px;display:none;" onclick="resetGraph()">âŸ² Start Over</button>
    </div>
  </div>
</div>
<div id="editPop" class="edit-pop" style="display:none;"></div>
<script>
const allStages = [
  { label: "Infancy (0-1)", maxAge: 1 },
  { label: "Early Childhood (1-2)", maxAge: 2 },
  { label: "Middle Childhood (3-6)", maxAge: 6 },
  { label: "Late Childhood (7-12)", maxAge: 12 },
  { label: "Teenage (13-19)", maxAge: 19 },
  { label: "Early Adulthood (20-29)", maxAge: 29 },
  { label: "Middle Adulthood (30-45)", maxAge: 45 },
  { label: "Late Middle Age(46-64)", maxAge: 64 },
  { label: "Later Years(65 or older)", maxAge: 120 }
];
let currentStep=0, characterAge=null, relevantStages=[], results=[];

// --- Character name parsing, with capitalization ---
function capitalize(str) {
  if (!str) return "";
  return str.charAt(0).toUpperCase() + str.slice(1);
}
let character = decodeURIComponent((location.search.match(/character=([^&]+)/)||[])[1]||"");
if(!character) character = prompt("Character name or ID?");
if(!character) character = "default";
document.getElementById("titleHead").innerText = `ðŸ§  Life Graph: ${capitalize(character)}`;
// ---------------------------------------------------

const mainStep = document.getElementById('mainStep');
const canvas = document.getElementById('lifeGraph');
const ctx = canvas.getContext('2d');
const editPop = document.getElementById('editPop');
const resetBtn = document.getElementById('resetBtn');

function loadFromStorage() {
  const d = localStorage.getItem("lifeGraphData_" + character);
  if(d) {
    try { results = JSON.parse(d)||[]; } catch(e){ results = []; }
  } else { results = []; }
}
function saveToStorage() {
  localStorage.setItem("lifeGraphData_" + character, JSON.stringify(results));
}
function resetGraph() {
  if(confirm("Start over and redo the Life Graph wizard?")) {
    localStorage.removeItem("lifeGraphData_" + character);
    location.reload();
  }
}

function nextStep() {
  if(currentStep===0){
    characterAge=parseInt(document.getElementById('ageInput').value);
    if(isNaN(characterAge)||characterAge<0)return alert('Please enter a valid age.');
    results=[];
    relevantStages=allStages.filter(stage=>stage.maxAge<=characterAge);
    const currentStage=allStages.find(s=>characterAge<=s.maxAge);
    if(currentStage&&(!relevantStages.length||relevantStages[relevantStages.length-1].label!==currentStage.label)){relevantStages.push(currentStage);}
    currentStep++;renderStep();
  }else if(currentStep<=relevantStages.length){
    const score=parseInt(document.getElementById('scoreInput').value);
    const note=document.getElementById('noteInput').value;
    if(isNaN(score)||score<-10||score>10)return alert('Enter a score from -10 to +10.');
    results.push({stage:relevantStages[currentStep-1].label,score,note});
    currentStep++;renderStep();
  }else{
    saveToStorage();
    showGraph();
  }
}
function renderStep(){
  canvas.style.display='none'; resetBtn.style.display='none';
  if(results.length>0 && localStorage.getItem("lifeGraphData_" + character)) { showGraph(); return; }
  if(currentStep===0){
    mainStep.innerHTML='<label>How old is this character?</label><input id="ageInput" type="number" placeholder="e.g. 38" /><button onclick="nextStep()">Next</button>';
  }else if(currentStep<=relevantStages.length){
    const label=relevantStages[currentStep-1].label;
    mainStep.innerHTML=`<label>How was their ${label.toLowerCase()}?</label><textarea id="noteInput" placeholder="Describe this time in their life..."></textarea><label>Rate this time from -10 to +10:</label><input id="scoreInput" type="number" min="-10" max="10" /><button onclick="nextStep()">Next</button>`;
  }
}
function showGraph(){
  mainStep.innerHTML = "";
  canvas.style.display = "block"; resetBtn.style.display="inline-block";
  drawGraph();
}

// Responsive canvas resize function (always call before drawing)
function resizeCanvasToDisplaySize(canvas) {
  const width = canvas.clientWidth;
  const height = canvas.clientHeight;
  if (canvas.width !== width || canvas.height !== height) {
    canvas.width = width;
    canvas.height = height;
    return true;
  }
  return false;
}

function drawGraph(){
  resizeCanvasToDisplaySize(canvas);
  const w=canvas.width,h=canvas.height,pad=Math.max(50, w * 0.055);
  ctx.clearRect(0,0,w,h);
  ctx.save();
  // vertical scale
  ctx.font='15px Inter';ctx.fillStyle='#8ac6ff';ctx.textAlign='right';
  for(let i=-10;i<=10;i+=5){
    const y=h/2-i*(h-pad*2)/20;
    ctx.fillText(i, pad-22, y+6);
    ctx.beginPath();ctx.moveTo(pad, y);ctx.lineTo(w-pad+16, y);
    ctx.strokeStyle='#1f3f6c';ctx.lineWidth=1;ctx.stroke();
  }
  if(results.length>1){
    const step=(w-pad*2)/(results.length-1);
    const points = results.map((r,i)=>[pad+i*step, h/2 - r.score*(h-pad*2)/20]);
    // Filled wave
    ctx.save();
    ctx.beginPath();
    ctx.moveTo(points[0][0],h-pad);
    ctx.lineTo(points[0][0],points[0][1]);
    for(let i=0;i<points.length-1;i++){
      const [x1,y1]=points[i], [x2,y2]=points[i+1];
      const cx1=x1+(x2-x1)/3,cy1=y1, cx2=x2-(x2-x1)/3,cy2=y2;
      ctx.bezierCurveTo(cx1,cy1,cx2,cy2,x2,y2);
    }
    ctx.lineTo(points[points.length-1][0],h-pad);
    ctx.closePath();
    const fillGrad=ctx.createLinearGradient(pad,h/2,w-pad,h/2);
    fillGrad.addColorStop(0,'rgba(255,88,120,0.24)');
    fillGrad.addColorStop(0.45,'rgba(88,128,255,0.12)');
    fillGrad.addColorStop(1,'rgba(88,250,255,0.17)');
    ctx.fillStyle=fillGrad;ctx.globalAlpha=0.94;ctx.fill();ctx.restore();
    // Wave line
    ctx.save(); ctx.beginPath();
    ctx.moveTo(points[0][0],points[0][1]);
    for(let i=0;i<points.length-1;i++){
      const [x1,y1]=points[i], [x2,y2]=points[i+1];
      const cx1=x1+(x2-x1)/3,cy1=y1, cx2=x2-(x2-x1)/3,cy2=y2;
      ctx.bezierCurveTo(cx1,cy1,cx2,cy2,x2,y2);
    }
    const grad=ctx.createLinearGradient(pad,0,w-pad,0);
    grad.addColorStop(0,'#ff244d');
    grad.addColorStop(0.3,'#b94bff');
    grad.addColorStop(0.7,'#33c6fa');
    grad.addColorStop(1,'#0be5ed');
    ctx.strokeStyle=grad;ctx.lineWidth=6;
    ctx.shadowColor='#94d2ffbb';ctx.shadowBlur=12;ctx.stroke();ctx.shadowBlur=0;ctx.restore();
  }
  // Dots + labels
  ctx.save();
  ctx.font='bold 15px Inter'; ctx.textAlign='center';
  const step=results.length>1?(w-pad*2)/(results.length-1):0;
  results.forEach((r,i)=>{
    const x=pad+(results.length>1?i*step:0),y=h/2-r.score*(h-pad*2)/20;
    // Dot
    ctx.save();ctx.beginPath();ctx.arc(x,y,Math.max(11,w*0.012),0,Math.PI*2);
    ctx.fillStyle='#ffe6fa';ctx.shadowColor='#ff3c8e77';ctx.shadowBlur=12;ctx.globalAlpha=0.85;ctx.fill();ctx.shadowBlur=0;ctx.globalAlpha=1;ctx.restore();
    // Score
    ctx.font='bold 16px Inter';ctx.fillStyle='#ff90b3';ctx.fillText(r.score,x,y-20);
    // Stage
    ctx.font='bold 15px Inter';ctx.fillStyle='#fff';ctx.fillText(r.stage,x,h-14);
    // Hover/Click areas for interactivity
    canvas.onmousemove = function(e){
      let rect = canvas.getBoundingClientRect();
      let mx = e.clientX - rect.left, my = e.clientY - rect.top;
      let found = false;
      results.forEach((r2,j)=>{
        const xx=pad+(results.length>1?j*step:0),yy=h/2-r2.score*(h-pad*2)/20;
        if(Math.sqrt((mx-xx)**2+(my-yy)**2)<Math.max(13,w*0.014)){
          canvas.style.cursor = "pointer"; found = true;
        }
      });
      if(!found) canvas.style.cursor = "";
    };
    canvas.onclick = function(e){
      let rect = canvas.getBoundingClientRect();
      let mx = e.clientX - rect.left, my = e.clientY - rect.top;
      results.forEach((r2,j)=>{
        const xx=pad+(results.length>1?j*step:0),yy=h/2-r2.score*(h-pad*2)/20;
        if(Math.sqrt((mx-xx)**2+(my-yy)**2)<Math.max(13,w*0.014)){
          showEditNode(j);
        }
      });
    }
  });
  ctx.restore();
}
function showEditNode(idx){
  const node = results[idx];
  editPop.innerHTML = `
    <h3>Edit: ${node.stage}</h3>
    <label>Score (-10 to +10)</label>
    <input id="editScore" type="number" min="-10" max="10" value="${node.score}" />
    <label>Note</label>
    <textarea id="editNote">${node.note||""}</textarea>
    <div style="text-align:right;">
      <button onclick="saveEditNode(${idx})">Save</button>
      <button onclick="editPop.style.display='none'">Cancel</button>
    </div>
  `;
  editPop.style.display = "block";
}
function saveEditNode(idx){
  let newScore = parseInt(document.getElementById('editScore').value);
  let newNote = document.getElementById('editNote').value;
  if(isNaN(newScore)||newScore<-10||newScore>10) return alert('Enter a score from -10 to +10.');
  results[idx].score = newScore; results[idx].note = newNote;
  saveToStorage();
  editPop.style.display = "none";
  drawGraph();
}
window.addEventListener('resize', ()=>{
  if(canvas.style.display === "block") drawGraph();
});
// On load
loadFromStorage();
if(results.length) { currentStep = 1e6; renderStep(); showGraph(); } else { renderStep(); }
</script>
</body>
</html>
