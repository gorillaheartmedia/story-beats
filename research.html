<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Research Archive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    html, body {background: linear-gradient(135deg, #173161 60%, #2257a7 100%);
      min-height: 100vh; margin: 0; padding: 0; font-family: 'Inter', Arial, sans-serif; color: #eaf3ff;}
    .container {max-width: 1040px;margin: 30px auto;background: rgba(24,39,70,0.99);border-radius: 18px;box-shadow: 0 4px 28px #06103a66;padding: 30px 28px 42px 28px;border: 1.5px solid #3b82f644;}
    h1 {font-size: 2em;color: #fff;margin-bottom: 18px;letter-spacing: 0.01em;}
    .project-banner {background:#60a5fa17; color:#fffbb0; font-size:1.12em; font-weight:600; border-radius:8px; margin-bottom:22px; padding:8px 16px;}
    .project-banner button {margin-left:22px;font-size:0.98em;padding:5px 17px;border-radius:6px;border:none;background:#2563ebcc;color:#ffe285;cursor:pointer;transition:background .13s;}
    .project-banner button:hover {background:#ffe285bb;color:#1a377b;}
    .add-btn {background: linear-gradient(92deg, #2671f2, #2959de 90%);color: #fff;border: none;border-radius: 7px;font-weight: 600;font-size: 1.07em;padding: 8px 22px;margin-bottom: 23px;cursor: pointer;float: right;margin-top: -14px;}
    .add-btn:hover {background: linear-gradient(92deg, #2959de 0%, #60a5fa 100%);color: #e0f4ff;}
    .filter-bar {margin: 18px 0 19px 0;display: flex; flex-wrap: wrap; gap: 14px;align-items: center;}
    .filter-bar input, .filter-bar select {padding: 6px 11px; border-radius: 6px; border: 1.2px solid #284687;background: #19306a44; color: #eaf3fa; font-size: 1em;outline: none;}
    .filter-bar input:focus, .filter-bar select:focus { border: 1.8px solid #3b82f6;}
    .grid {display: grid; grid-template-columns: repeat(auto-fit,minmax(270px,1fr));gap: 18px;}
    .card {background: #193362ed;border-radius: 12px;box-shadow: 0 2px 11px #19336229;padding: 17px 13px 13px 13px;position: relative;overflow: hidden;transition: box-shadow .13s;cursor: pointer;}
    .card:hover {box-shadow: 0 6px 22px #1b3257a6;z-index: 2;outline: 2px solid #a4d2ff88;}
    .thumb {width: 100%; max-height: 145px; object-fit: cover; border-radius: 10px;display: block; margin-bottom: 11px; background: #0f2246;}
    .type-label {background: #3b82f6a9; color: #ffe285;font-weight: 700; font-size: .97em; border-radius: 7px;padding: 2.5px 10px; display: inline-block;margin-bottom: 7px;margin-right: 4px;}
    .label {font-size: 1.13em;font-weight: 700;color: #fffdd7;margin-bottom: 5px;display: block;}
    .tags, .links-row {margin-top: 2px;display: flex; flex-wrap: wrap; gap: 6px;}
    .tag, .linktag {background: #2563eb33;color: #bee1fd;padding: 3px 10px;border-radius: 4px;font-size: .97em;border: 1.1px solid #3b82f655;font-weight: 500;margin-bottom: 2px;}
    .date {color: #a5d6fd;font-size: .92em;opacity: .7;margin-top: 2px;}
    .card-pin {position: absolute; left: 11px; top: 9px; font-size: 1.46em; color: #ffe285c7;background: none; border: none; cursor: pointer; z-index: 3; transition: color .11s;filter: drop-shadow(0 0 2px #fffbe933);}
    .card-pin.pinned { color: #ffea00; text-shadow: 0 2px 12px #fffbb088;}
    .card-pin:hover { color: #fff7a3;}
    .card-btns {position: absolute; right: 12px; top: 10px; display: flex; gap: 6px;}
    .card-btns button {background: none; color: #aee5ff; border: none; cursor: pointer; font-size: 1.18em;padding: 0 2px; transition: color .12s;}
    .card-btns button:hover { color: #ffe285; }
    .modal-bg {display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; z-index: 999;background: rgba(19,43,97,0.33); align-items: center; justify-content: center;}
    .modal {background: #19377a;color: #eaf3ff;padding: 36px 34px 24px 32px;border-radius: 20px;min-width: 375px; max-width: 98vw;max-height: 98vh;box-shadow: 0 7px 33px #1c378899, 0 1px 1.5px #1933621c;border: 1.8px solid #25477c;position: relative;font-size: 1.13em;overflow-y: auto;animation: fadein .22s;}
    .modal .close-btn {position: absolute; right: 13px; top: 10px; background: none;border: none; font-size: 1.32em; color: #99c8ff; cursor: pointer;}
    .modal label { font-weight: 600; margin-top: 12px; display: block; }
    .modal input, .modal textarea, .modal select {margin: 10px 0 0 0; width: 100%; max-width: 420px; font-size: 1.07em;}
    .modal textarea { min-height: 54px; }
    .modal .tag, .modal .linktag {margin-top: 0;}
    .modal .modal-btns { margin-top: 16px; }
    .modal-btns button {font-size: 1.09em;padding: 8px 22px;border-radius: 8px;background: linear-gradient(92deg, #2671f2, #2959de 90%);color: #fff;border: none;box-shadow: 0 2px 9px #10399a24;font-weight: 600;margin-right: 11px;margin-bottom: 4px;transition: background .15s, color .13s;cursor: pointer;}
    .modal-btns button:hover {background: linear-gradient(92deg, #2959de 0%, #60a5fa 100%);color: #e0f4ff;}
    .modal-preview {display: flex;align-items: flex-start;gap: 22px;margin-bottom: 14px;flex-wrap: wrap;}
    .modal-preview-media {flex: 1 1 320px;max-width: 440px;margin-bottom: 12px;text-align: center;}
    .modal-preview-media img,.modal-preview-media video,.modal-preview-media audio {max-width: 100%;max-height: 370px;border-radius: 13px;margin-bottom: 9px;background: #142e5e;display: block;margin-left: auto; margin-right: auto;}
    .modal-meta {flex: 2 1 240px;min-width: 220px;margin-top: 8px;}
    .modal-meta .tags, .modal-meta .links-row { margin-bottom: 8px;}
    .modal-meta .date { margin-bottom: 8px;}
    .modal-controls {display: flex;gap: 13px;margin: 9px 0 12px 0;align-items: center;}
    .modal-controls button {padding: 6px 13px;font-size: 1em;border-radius: 6px;background: #2563ebb0;color: #fffbb0;border: none;cursor: pointer;transition: background .11s;}
    .modal-controls button:hover { background: #ffe285bb; color: #1a377b; }
    .modal-controls .pin-btn.pinned { color: #ffea00; background: #253f11; }
    .picker-modal-bg {display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;z-index:10000;background:rgba(15,25,55,0.44);align-items:center;justify-content:center;}
    .picker-modal {background:#14233d;padding:38px 36px 22px 36px;border-radius:18px;box-shadow:0 6px 40px #12326d66;min-width:340px;max-width:98vw;}
    .picker-modal h2 {color:#fffbb0;margin-bottom:18px;font-size:1.23em;}
    .picker-modal label {font-size:1.07em;font-weight:600;color:#b2e8ff;}
    .picker-modal select {width:100%;margin:11px 0 21px 0;padding:7px 14px;border-radius:7px;}
    .picker-modal button {font-size:1.07em;background:linear-gradient(92deg,#2959de,#60a5fa 100%);color:#fff;padding:8px 24px;border-radius:8px;border:none;font-weight:700;cursor:pointer;transition:background .13s;}
    .picker-modal button:hover {background:#4befff;color:#193362;}
    @keyframes fadein { from { opacity: 0; transform: translateY(36px);} to {opacity:1;transform:none;}}
.fab-research {
  position: fixed;
  right: 32px;
  bottom: 32px;
  z-index: 9999;
  width: 62px;
  height: 62px;
  background: linear-gradient(130deg, #4befff 60%, #1958ca 100%);
  border-radius: 50%;
  box-shadow: 0 2px 22px #2b7aff66;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background .14s, box-shadow .12s;
}
.fab-research:hover {
  background: linear-gradient(110deg, #1958ca 40%, #4befff 100%);
  box-shadow: 0 4px 34px #3be3ff99;
}
.fab-research .fab-icon {
  font-size: 2em;
  color: #14283c;
  filter: drop-shadow(0 2px 4px #fffbe933);
  user-select: none;
}
.fab-research:after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 78px;
  right: 0;
  background: #14283ccc;
  color: #fffbb0;
  padding: 6px 16px;
  border-radius: 9px;
  font-size: 1em;
  font-weight: 500;
  pointer-events: none;
  opacity: 0;
  transform: translateY(12px);
  transition: opacity .17s, transform .17s;
  white-space: nowrap;
}
.fab-research:hover:after {
  opacity: 1;
  transform: translateY(0);
}
</style>
<script>
  getProjectId().then(projectId => {
    console.log("Current projectId:", projectId);
    if (!projectId) {
      alert("No project selected!");
      window.location.href = "dashboard.html";
    }
  });
</script>
</head>
<body>
  <div class="container">
    <h1>Research Archive
      <button class="add-btn" onclick="safeOpenResearchModal()">+ Add Entry</button>
    </h1>
    <div class="project-banner" id="projectBanner"></div>
    <div class="filter-bar">
      <input id="searchBox" type="text" placeholder="Search label, tags, notes..." oninput="renderGrid()">
      <select id="typeFilter" onchange="renderGrid()">
        <option value="">All Types</option>
        <option value="image">Image</option>
        <option value="video">Video</option>
        <option value="audio">Audio</option>
        <option value="link">Link</option>
        <option value="document">Document</option>
        <option value="note">Note/Idea</option>
      </select>
      <input id="tagFilter" type="text" placeholder="Tag filter..." oninput="renderGrid()">
      <label style="font-weight:500; margin-left:12px;">
        <input type="checkbox" id="pinFilter" onchange="renderGrid()" style="margin-right:4px;vertical-align:-2px;">Show only pinned
      </label>
    </div>
    <div class="grid" id="archiveGrid"></div>

    <!-- Project Picker Modal -->
    <div class="picker-modal-bg" id="pickerModalBg" style="display:none">
      <div class="picker-modal">
        <h2>Select a Project</h2>
        <label for="pickerProjectSelect">Project</label>
        <select id="pickerProjectSelect"></select>
        <button onclick="setProjectFromPicker()">Select</button>
      </div>
    </div>

    <!-- Add/Edit Research Modal -->
    <div class="modal-bg" id="researchModalBg">
      <div class="modal" onclick="event.stopPropagation()">
        <button class="close-btn" onclick="closeResearchModal()">√ó</button>
        <form id="researchForm" onsubmit="saveResearch();return false;">
          <label>Research Label
            <input type="text" id="modalLabel" maxlength="120" required>
          </label>
          <label>Type
            <select id="modalType" onchange="toggleTypeFields()">
              <option value="image">Image</option>
              <option value="video">Video</option>
              <option value="audio">Audio</option>
              <option value="link">Link</option>
              <option value="document">Document</option>
              <option value="note">Note/Idea</option>
            </select>
          </label>
          <div id="fileField" style="display:none">
            <label>Upload File
              <input type="file" id="modalFile">
            </label>
          </div>
          <div id="urlField" style="display:none">
            <label>URL
              <input type="url" id="modalURL" placeholder="https://...">
            </label>
          </div>
          <label>Description / Notes
            <textarea id="modalDesc" maxlength="2000"></textarea>
          </label>
          <label>Tags</label>
          <div class="tags" id="modalTagList"></div>
          <input type="text" id="modalTagInput" placeholder="Add tag and press Enter" onkeydown="if(event.key==='Enter'){addModalTag();return false;}">
          <div class="modal-btns">
            <button type="submit">Save</button>
            <button type="button" onclick="closeResearchModal()">Cancel</button>
            <button type="button" id="deleteResearchBtn" style="color:#ffb0b0; float:right;">üóëÔ∏è Delete</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Project Mismatch Warning Modal -->
    <div class="modal-bg" id="projectWarningBg" style="display:none;">
      <div class="modal" style="text-align:center;">
        <h2>‚ö†Ô∏è Project Mismatch</h2>
        <p>You are about to add or edit research for a project that is <b>not the currently loaded project</b>.</p>
        <p>Please check your project context before proceeding.</p>
        <div style="margin-top:18px;">
          <button onclick="closeProjectWarning()">Go Back</button>
          <button style="margin-left:10px;" onclick="proceedAnyway()">Proceed Anyway</button>
        </div>
      </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal-bg" id="previewModalBg" onclick="closePreviewModal()">
      <div class="modal" id="previewModal" onclick="event.stopPropagation()">
        <button class="close-btn" onclick="closePreviewModal()">√ó</button>
        <div class="modal-controls" style="margin-bottom:10px;">
          <button onclick="prevPreview(event)">‚èÆ Prev</button>
          <button onclick="nextPreview(event)">Next ‚è≠</button>
          <button id="pinBtn" onclick="togglePin(event)" class="pin-btn">‚≠ê Pin</button>
          <button onclick="downloadPreview()">‚¨áÔ∏è Download</button>
          <button onclick="copyPreview()">üìã Copy</button>
          <button onclick="editPreview()">‚úèÔ∏è Edit</button>
          <button onclick="deletePreview()" style="color:#ffb0b0;">üóëÔ∏è Delete</button>
        </div>
        <div class="modal-preview" id="previewMediaRow"></div>
        <div class="modal-meta" id="previewMeta"></div>
      </div>
    </div>
  </div>
<script>
// -------- IndexedDB Setup --------
const DB_NAME = "ResearchArchiveDB";
const DB_STORE = "files";
const DB_VERSION = 1;

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = function (e) {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(DB_STORE)) {
        db.createObjectStore(DB_STORE, { keyPath: "id" });
      }
    };
    req.onsuccess = e => resolve(e.target.result);
    req.onerror = e => reject(e.target.error);
  });
}

async function saveFileToDB(file) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const id = Date.now() + "_" + file.name;
    const tx = db.transaction(DB_STORE, "readwrite");
    tx.objectStore(DB_STORE).put({ id, file });
    tx.oncomplete = () => resolve(id);
    tx.onerror = e => reject(e.target.error);
  });
}

async function getFileFromDB(id) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(DB_STORE, "readonly");
    const req = tx.objectStore(DB_STORE).get(id);
    req.onsuccess = () => resolve(req.result ? req.result.file : null);
    req.onerror = e => reject(e.target.error);
  });
}

// -------- Project Picker Integration --------

function getProjects() {
  try {
    const projects = JSON.parse(localStorage.getItem("plotProjects") || "[]");
    return Array.isArray(projects) ? projects : [];
  } catch (e) {
    console.warn("plotProjects malformed!", e);
    return [];
  }
}

function showProjectPicker() {
  const pickerBg = document.getElementById("pickerModalBg");
  const pickerSelect = document.getElementById("pickerProjectSelect");
  pickerSelect.innerHTML = "";

  const projects = getProjects();
  if (!projects.length) {
    pickerSelect.innerHTML = "<option disabled>No projects found</option>";
  } else {
    projects.forEach(p => {
      const option = document.createElement("option");
      option.value = p.id;
      option.textContent = (p.meta?.storyTitle || 'Untitled') + " ‚Äî " + p.id;
      pickerSelect.appendChild(option);
    });
  }
  pickerBg.style.display = "flex";
}

function setProjectFromPicker() {
  const pickerSelect = document.getElementById("pickerProjectSelect");
  const selectedId = pickerSelect.value;
  const projects = getProjects();
  const project = projects.find(p => p.id === selectedId);
  if (project) {
    localStorage.setItem("currentProjectTitle", project.meta?.storyTitle || project.title || "Untitled");
    localStorage.setItem("currentProjectId", project.id);
    document.getElementById("pickerModalBg").style.display = "none";
    window.location.reload();
  } else {
    alert("Error: project not found!");
  }
}

// --------- Research Archive Logic -----------

let archive = [];
let editingIdx = null;
let previewIdx = null;
let filterPin = false;

function getArchive() {
  const pid = localStorage.getItem("currentProjectId");
  if (!pid) return [];
  return JSON.parse(localStorage.getItem("researchArchive_" + pid) || "[]");
}
function setArchive(arr) {
  const pid = localStorage.getItem("currentProjectId");
  if (pid)
    localStorage.setItem("researchArchive_" + pid, JSON.stringify(arr));
}

// --------- Rendering Logic -----------

function renderGrid() {
  archive = getArchive();
  const grid = document.getElementById("archiveGrid");
  const search = document.getElementById("searchBox").value.toLowerCase();
  const tag = document.getElementById("tagFilter").value.toLowerCase();
  const type = document.getElementById("typeFilter").value;
  filterPin = document.getElementById("pinFilter").checked;

  let filtered = archive.filter(e => {
    if (type && e.type !== type) return false;
    if (filterPin && !e.pinned) return false;
    if (search && !(
      (e.label || "").toLowerCase().includes(search) ||
      (e.notes || "").toLowerCase().includes(search) ||
      (e.tags || []).join(" ").toLowerCase().includes(search)
    )) return false;
    if (tag && !(e.tags || []).some(t => t.toLowerCase().includes(tag))) return false;
    return true;
  });

  grid.innerHTML = "";
  filtered.forEach((entry, i) => {
    let div = document.createElement("div");
    div.className = "card";

    if (entry.type === "image" && (entry.url || entry.fileId)) {
      if (entry.fileId) {
        getFileFromDB(entry.fileId).then(file => {
          if (file) {
            const url = URL.createObjectURL(file);
            div.innerHTML += `<img class="thumb" src="${url}" alt="img">`;
          }
        });
      } else {
        div.innerHTML += `<img class="thumb" src="${entry.url}" alt="img">`;
      }
    } else if (entry.type === "video" && (entry.url || entry.fileId)) {
      if (entry.fileId) {
        getFileFromDB(entry.fileId).then(file => {
          if (file) {
            const url = URL.createObjectURL(file);
            div.innerHTML += `<video class="thumb" src="${url}" controls></video>`;
          }
        });
      } else {
        div.innerHTML += `<video class="thumb" src="${entry.url}" controls></video>`;
      }
    } else if (entry.type === "audio" && (entry.url || entry.fileId)) {
      if (entry.fileId) {
        getFileFromDB(entry.fileId).then(file => {
          if (file) {
            const url = URL.createObjectURL(file);
            div.innerHTML += `<audio class="thumb" src="${url}" controls></audio>`;
          }
        });
      } else {
        div.innerHTML += `<audio class="thumb" src="${entry.url}" controls></audio>`;
      }
    }

    div.innerHTML += `
      <span class="type-label">${entry.type ? entry.type[0].toUpperCase() + entry.type.slice(1) : ""}</span>
      <span class="label">${entry.label || "(Untitled)"}</span>
      <div class="tags">${(entry.tags || []).map(t => `<span class="tag">${t}</span>`).join("")}</div>
      <div class="date">${entry.date ? new Date(entry.date).toLocaleString() : ""}</div>
      <button class="card-pin${entry.pinned ? " pinned" : ""}" title="Pin" onclick="event.stopPropagation(); togglePinEntry(${i});">${entry.pinned ? "‚≠ê" : "‚òÜ"}</button>
      <div class="card-btns">
        <button title="Preview" onclick="event.stopPropagation(); previewEntry(${i});">üëÅÔ∏è</button>
        <button title="Edit" onclick="event.stopPropagation(); safeOpenResearchModal(${i});">‚úèÔ∏è</button>
        <button title="Delete" onclick="event.stopPropagation(); deleteEntry(${i});" style="color:#ffb0b0;">üóëÔ∏è</button>
      </div>
    `;
    div.onclick = () => previewEntry(i);
    grid.appendChild(div);
  });
}

function togglePinEntry(idx) {
  archive = getArchive();
  archive[idx].pinned = !archive[idx].pinned;
  setArchive(archive);
  renderGrid();
}
function deleteEntry(idx) {
  if (!confirm("Delete this entry?")) return;
  archive = getArchive();
  archive.splice(idx, 1);
  setArchive(archive);
  renderGrid();
}

function previewEntry(idx) {
  previewIdx = idx;
  archive = getArchive();
  const entry = archive[idx];
  document.getElementById("previewModalBg").style.display = "flex";
  const mediaRow = document.getElementById("previewMediaRow");
  mediaRow.innerHTML = "";

  if (entry.type === "image" && (entry.url || entry.fileId)) {
    if (entry.fileId) {
      getFileFromDB(entry.fileId).then(file => {
        if (file) mediaRow.innerHTML += `<img src="${URL.createObjectURL(file)}" style="max-width:100%;">`;
      });
    } else {
      mediaRow.innerHTML += `<img src="${entry.url}" style="max-width:100%;">`;
    }
  } else if (entry.type === "video" && (entry.url || entry.fileId)) {
    if (entry.fileId) {
      getFileFromDB(entry.fileId).then(file => {
        if (file) mediaRow.innerHTML += `<video src="${URL.createObjectURL(file)}" controls style="max-width:100%"></video>`;
      });
    } else {
      mediaRow.innerHTML += `<video src="${entry.url}" controls style="max-width:100%"></video>`;
    }
  } else if (entry.type === "audio" && (entry.url || entry.fileId)) {
    if (entry.fileId) {
      getFileFromDB(entry.fileId).then(file => {
        if (file) mediaRow.innerHTML += `<audio src="${URL.createObjectURL(file)}" controls style="width:100%"></audio>`;
      });
    } else {
      mediaRow.innerHTML += `<audio src="${entry.url}" controls style="width:100%"></audio>`;
    }
  } else if (entry.type === "document") {
    if (entry.fileId) {
      getFileFromDB(entry.fileId).then(file => {
        if (file) {
          const url = URL.createObjectURL(file);
          mediaRow.innerHTML += `<a href="${url}" download="${entry.fileName || 'download'}">Download ${entry.fileName || 'file'}</a>`;
        }
      });
    } else if (entry.url) {
      mediaRow.innerHTML += `<a href="${entry.url}" target="_blank">Open Document</a>`;
    }
  } else if (entry.type === "link" && entry.url) {
    mediaRow.innerHTML += `<a href="${entry.url}" target="_blank">${entry.url}</a>`;
  }

  const meta = document.getElementById("previewMeta");
  meta.innerHTML = `
    <div class="label">${entry.label || "(Untitled)"}</div>
    <div class="type-label">${entry.type ? entry.type[0].toUpperCase() + entry.type.slice(1) : ""}</div>
    <div class="tags">${(entry.tags || []).map(t => `<span class="tag">${t}</span>`).join("")}</div>
    <div class="date">${entry.date ? new Date(entry.date).toLocaleString() : ""}</div>
    <div class="desc" style="margin-top:8px;">${entry.notes ? entry.notes.replace(/\n/g, "<br>") : ""}</div>
    <div style="margin-top:10px;color:#ffe285;">${entry.pinned ? "‚≠ê Pinned" : ""}</div>
  `;
  document.getElementById("pinBtn").className = "pin-btn" + (entry.pinned ? " pinned" : "");
}

function closePreviewModal() {
  document.getElementById("previewModalBg").style.display = "none";
}
function prevPreview(e) {
  e && e.stopPropagation();
  if (previewIdx === null) return;
  previewIdx = (previewIdx - 1 + archive.length) % archive.length;
  previewEntry(previewIdx);
}
function nextPreview(e) {
  e && e.stopPropagation();
  if (previewIdx === null) return;
  previewIdx = (previewIdx + 1) % archive.length;
  previewEntry(previewIdx);
}
function togglePin(e) {
  e && e.stopPropagation();
  if (previewIdx === null) return;
  togglePinEntry(previewIdx);
  previewEntry(previewIdx);
}

// ‚úÖ Updated for IndexedDB
async function downloadPreview() {
  if (previewIdx === null) return;
  const entry = archive[previewIdx];

  if (entry.fileId) {
    const file = await getFileFromDB(entry.fileId);
    if (file) {
      const url = URL.createObjectURL(file);
      const a = document.createElement("a");
      a.href = url;
      a.download = entry.fileName || "download";
      a.click();
    }
  } else if (entry.url) {
    window.open(entry.url, "_blank");
  } else {
    alert("No file or URL available.");
  }
}

function copyPreview() {
  if (previewIdx === null) return;
  const entry = archive[previewIdx];
  let text = `Label: ${entry.label}\nType: ${entry.type}\nNotes: ${entry.notes}\nURL: ${entry.url}\nTags: ${(entry.tags||[]).join(", ")}\n`;
  navigator.clipboard.writeText(text);
  alert("Copied!");
}
function editPreview() {
  if (previewIdx === null) return;
  safeOpenResearchModal(previewIdx);
  closePreviewModal();
}
function deletePreview() {
  if (previewIdx === null) return;
  if (!confirm("Delete this entry?")) return;
  archive = getArchive(); 
  archive.splice(previewIdx, 1);
  setArchive(archive);
  closePreviewModal();
  renderGrid();
  previewIdx = null;
}

// ---------- Modal Logic --------------

function safeOpenResearchModal(idx) {
  const curProjectId = localStorage.getItem("currentProjectId");
  const allProjects = getProjects();
  const valid = !!allProjects.find(p => p.id === curProjectId);
  if (!valid) {
    showProjectWarning();
    window._intentToEditIdx = idx;
    return;
  }
  openResearchModal(idx);
}

function showProjectWarning() {
  document.getElementById("projectWarningBg").style.display = "flex";
}
function closeProjectWarning() {
  document.getElementById("projectWarningBg").style.display = "none";
  window._intentToEditIdx = null;
}
function proceedAnyway() {
  document.getElementById("projectWarningBg").style.display = "none";
  openResearchModal(window._intentToEditIdx || null);
  window._intentToEditIdx = null;
}

function openResearchModal(idx) {
  editingIdx = idx;
  let entry = idx != null ? getArchive()[idx] : {};
  document.getElementById("modalLabel").value = entry.label || "";
  document.getElementById("modalType").value = entry.type || "note";
  document.getElementById("modalDesc").value = entry.notes || "";
  modalTags = entry.tags ? [...entry.tags] : [];
  renderModalTags();
  document.getElementById("modalURL").value = entry.url || "";
  document.getElementById("modalFile").value = "";
  toggleTypeFields();

  const delBtn = document.getElementById("deleteResearchBtn");
  if (delBtn) {
    delBtn.style.display = (editingIdx != null) ? "" : "none";
    delBtn.onclick = function() {
      if (editingIdx == null) return;
      if (confirm("Delete this entry?")) {
        let arr = getArchive();
        arr.splice(editingIdx, 1);
        setArchive(arr);
        closeResearchModal();
        renderGrid();
        editingIdx = null;
      }
    };
  }

  document.getElementById("researchModalBg").style.display = "flex";
}
function closeResearchModal() {
  document.getElementById("researchModalBg").style.display = "none";
}

// ‚úÖ Updated saveResearch for IndexedDB
async function saveResearch() {
  let label = document.getElementById("modalLabel").value.trim();
  let type = document.getElementById("modalType").value;
  let notes = document.getElementById("modalDesc").value.trim();
  let url = document.getElementById("modalURL").value.trim();
  let tags = modalTags.slice();

  const fileInput = document.getElementById("modalFile");
  const file = fileInput.files[0];

  let entry = {
    label,
    type,
    notes,
    url,
    tags,
    date:
      editingIdx != null && getArchive()[editingIdx].date
        ? getArchive()[editingIdx].date
        : new Date().toISOString(),
    pinned: editingIdx != null && getArchive()[editingIdx].pinned,
    fileName: file ? file.name : null,
    fileId: null
  };

  if (file) {
    entry.fileId = await saveFileToDB(file);
  }

  finalizeSave(entry);
}

function finalizeSave(entry) {
  let arr = getArchive();
  if (editingIdx != null) arr[editingIdx] = entry;
  else arr.unshift(entry);
  setArchive(arr);
  closeResearchModal();
  renderGrid();
  editingIdx = null;
}

let modalTags = [];
function renderModalTags() {
  const tagList = document.getElementById("modalTagList");
  tagList.innerHTML = "";
  modalTags.forEach((tag, i) => {
    let el = document.createElement("span");
    el.className = "tag";
    el.innerHTML = tag + ' <button onclick="removeModalTag(' + i + ')" title="Remove">&times;</button>';
    tagList.appendChild(el);
  });
}
function addModalTag() {
  let input = document.getElementById("modalTagInput");
  let val = input.value.trim();
  if (val && !modalTags.includes(val)) {
    modalTags.push(val);
    input.value = "";
    renderModalTags();
  }
}
function removeModalTag(idx) {
  modalTags.splice(idx, 1);
  renderModalTags();
}
function toggleTypeFields() {
  let type = document.getElementById("modalType").value;
  document.getElementById("fileField").style.display =
    (type === "image" || type === "video" || type === "audio" || type === "document")
      ? "block"
      : "none";
  document.getElementById("urlField").style.display = (type === "link") ? "block" : "none";
}

// ------------ Modal Utility ------------

function showProjectBanner(title) {
  const banner = document.getElementById('projectBanner');
  banner.innerHTML =
    "Current Project: " + title +
    `<button onclick="window.location.reload()">Reload</button>` +
    `<button onclick="switchProject()">Switch Project</button>`;
}
function switchProject() {
  localStorage.removeItem("currentProjectTitle");
  localStorage.removeItem("currentProjectId");
  window.location.reload();
}

window.addEventListener('DOMContentLoaded', function() {
  const currentTitle = localStorage.getItem("currentProjectTitle");
  const currentId = localStorage.getItem("currentProjectId");
  const allProjects = getProjects();

  if (!currentTitle || !currentId || !allProjects.find(p => p.id === currentId)) {
    showProjectPicker();
  } else {
    showProjectBanner(currentTitle);
    renderGrid();
  }
});
</script>


</body>
</html>


